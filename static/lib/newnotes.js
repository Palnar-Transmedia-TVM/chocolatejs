// Generated by CoffeeScript 1.9.2
(function() {
  var Chocodown, Chocokup, Highlight, Newnotes, _, _module,
    hasProp = {}.hasOwnProperty,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  _ = require('./chocodash');

  Chocokup = require('./chocokup');

  Highlight = require('./highlight');

  Chocodown = require('./chocodown');

  Newnotes = (function() {
    _Class.kup = function() {
      var base, css_class, id, newnotes_filter, newnotes_filter_list, newnotes_list, newnotes_log_buttons, newnotes_note_action, newnotes_note_attributes, newnotes_note_history, newnotes_note_input, newnotes_note_memory, newnotes_note_message, newnotes_search, ref;
      id = Newnotes.panels.length;
      if ((base = this.params).taste == null) {
        base.taste = '';
      }
      style("#newnotes-" + id + "-note-panel > div {\n    line-height:1.1em;\n}\n\n#newnotes-" + id + "-note-panel code {\n    display: inline-block;\n    margin-left: 24px;\n}\n\n#newnotes-" + id + "-note-panel ul {\n    margin-left: 0;\n    padding-left: 1em;\n}\n\n#newnotes-" + id + "-filter-list-body {\n    margin: 10px;\n    font-size: 0.8em;\n    line-height: 1.4em;\n}\n\n#newnotes-" + id + "-note-panel li.note {\n    list-style: none;\n    line-height: 1.5em;\n}\n\n#newnotes-" + id + "-note-panel li {\n    list-style: disc;\n    list-style-position: inside;\n    line-height: 1.15em;\n}\n    \n#newnotes-" + id + "-note-panel li, #newnotes-" + id + "-filter-list-body div {\n    cursor: pointer;\n    padding: 0.4em 0;\n}\n\n#newnotes-" + id + "-note-panel li.compacted {\n    overflow: hidden;\n}\n\n#newnotes-" + id + "-note-panel li.compacted p,\n#newnotes-" + id + "-note-panel li.compacted p + * {\n    display:none;\n}\n\n#newnotes-" + id + "-note-panel > .fullscreen-narrow {\n    font-size:1.4em;\n}\n\n#newnotes-" + id + "-list-panel {\n    margin: 0;\n    padding: 1em;\n}\n\n#newnotes-" + id + "-note-panel select {\n    font-size: 0.8em;\n}\n\n#newnotes-" + id + "-filter-input {\n    width: 60%;\n    padding: 4px 10px 4px;\n    font-style: italic;\n    border: none;\n    font-size: 12px;\n    -moz-border-radius: 12px;\n    -webkit-border-radius: 12px;\n    -moz-box-shadow: inset 1px 1px 2px #bbb;\n    -webkit-box-shadow: inset 1px 1px 2px #bbb;\n    box-shadow: inset 1px 1px 2px #bbb;\n    color: #999;\n}\n\n" + (!this.params.inherit_selected_class ? '#newnotes-' + id + '-note-panel li.selected {background-color:rgba(0,0,0,0.1);}' : '') + "\n\n.newnotes-priority-Now {\n    color:red;\n}\n.newnotes-priority-Tomorrow {\n    color:gold;\n}\n.newnotes-priority-Later {\n    color:skyblue;\n}\n.newnotes-priority-Done {\n    color:lawngreen;\n}\n.newnotes-filtered {\n    background-color: gold;\n    color: black;\n}\n\n#newnotes-" + id + "-note-panel .leather, #newnotes-" + id + "-note-panel .leather a, #newnotes-" + id + "-note-panel .leather select  {\n    background-color: #262626;\n    color: rgb(165, 164, 151);\n    text-shadow: 0 1px 3px rgba(171, 128, 112, 0.5) , 0 -2px 4px rgb(0, 0, 0);\n    font-size: 14pt;\n    font-family: Comic Sans MS;\n}\n#newnotes-" + id + "-note-panel .leather select  {\n    font-size: 0.8em;\n}\n#newnotes-" + id + "-note-panel .leather a {\n    border: 1px solid rgb(26, 23, 23);\n    border-radius: 8px;\n    padding: 0px 10px 0px 8px;\n    box-shadow: inset 2px 2px 12px rgb(19, 17, 17);\n    text-decoration:none;\n}\n#newnotes-" + id + "-note-panel .leather > .sizer {\n    border: 1px dashed rgba(60, 66, 53, 1);\n    outline: 1px dashed rgba(171, 128, 112, 0.7);\n    margin: 6px;\n}\n#newnotes-" + id + "-note-panel .stitch > .sizer {\n    margin: 6px;\n}\n\n#newnotes-" + id + "-note-panel .paper {\n    background-color: rgb(245, 242, 209);\n    color: rgb(85, 78, 75);\n    text-shadow: none;\n    border-right: 6px double rgb(202, 195, 181);\n    border-top-right-radius: 10px;\n    border-bottom-right-radius: 10px;\n    border-left: 2px solid rgb(119, 118, 112);\n    font-size: 12pt;\n    border-bottom: 1px solid black;\n    background: -webkit-linear-gradient(top, rgb(228, 228, 228) 0%, rgb(245, 242, 209) 8%) 0 57px;\n    background: -moz-linear-gradient(top, rgb(228, 228, 228) 0%, rgb(245, 242, 209) 8%) 0 57px;\n    background: linear-gradient(top, rgb(228, 228, 228) 0%, rgb(245, 242, 209) 8%) 0 57px;\n    -webkit-background-size: 100% 30px;\n    -moz-background-size: 100% 30px;\n    -ms-background-size: 100% 30px;\n    background-size: 100% 30px;\n    background-position-y: 12px;\n    background-attachment: local;\n}\n\n#newnotes-" + id + "-note-panel .paper.disconnected {\n    background: rgb(219, 219, 219);\n}\n\n#newnotes-" + id + "-note-panel .white-paper {\n    background-color: rgb(247, 246, 232);\n    border-radius: 14px;\n    padding: 10px;\n    color: rgb(85, 78, 75);\n    text-shadow: none;\n    font-size: 12pt;\n    background: -webkit-linear-gradient(top, rgb(228, 228, 228) 0%, rgb(247, 246, 232) 8%) 0 57px;\n    background: -moz-linear-gradient(top, rgb(228, 228, 228) 0%, rgb(247, 246, 232) 8%) 0 57px;\n    background: linear-gradient(top, rgb(228, 228, 228) 0%, rgb(247, 246, 232) 8%) 0 57px;\n    -webkit-background-size: 100% 30px;\n    -moz-background-size: 100% 30px;\n    -ms-background-size: 100% 30px;\n    background-size: 100% 30px;\n    background-position-y: 12px;\n    background-attachment: local;\n}");
      style(this.params.code_css);
      css_class = (ref = this.params.box_css_class) != null ? ref : '';
      if (css_class !== '') {
        css_class = '.' + css_class;
      }
      newnotes_list = function() {
        return body("#newnotes-" + id + "-list-main", function() {
          return box('#.' + css_class, function() {
            return body("#newnotes-" + id + "-list-body.paper", function() {
              return ul("#newnotes-" + id + "-list-panel", '');
            });
          });
        });
      };
      newnotes_filter = function() {
        return div(function() {
          a({
            href: '#',
            onclick: "Newnotes.panels[" + id + "].stop_filter();"
          }, 'Find');
          text(' : ');
          input("#newnotes-" + id + "-filter-input", {
            onkeyup: "Newnotes.panels[" + id + "].on_key_filter(this);",
            onfocus: "Newnotes.panels[" + id + "].on_filter_focus(this);"
          });
          return a({
            href: '#',
            onclick: "Newnotes.panels[" + id + "].init_filter();"
          }, 'Clear');
        });
      };
      newnotes_filter_list = function(options) {
        var hidden;
        hidden = (options != null ? options.hidden : void 0) ? '.hidden' : '';
        return body(("#newnotes-" + id + "-filter-list-main") + hidden, function() {
          return box('#.' + css_class, function() {
            return body("#newnotes-" + id + "-filter-list-body.white-paper", function() {});
          });
        });
      };
      newnotes_search = function() {
        var add_selector, name, ref1, results;
        add_selector = (function(_this) {
          return function(name) {
            return select(("#newnotes-" + id + "-search-" + (name.toLowerCase()) + "-select") + css_class, {
              onchange: "Newnotes.panels[" + id + "].on_search_option_selected('" + name + "', this);"
            }, '');
          };
        })(this);
        span('#', function() {
          text('Pin');
          select(("#newnotes-" + id + "-pin-mode") + css_class, {
            onchange: "Newnotes.panels[" + id + "].on_pin_mode_changed(this);"
          }, function() {
            option('on');
            return option('off');
          });
          span(': ');
          span("#newnotes-" + id + "-pin-list", function() {
            return 'None';
          });
          return a({
            href: '#',
            onclick: "Newnotes.panels[" + id + "].pin();"
          }, '+');
        });
        ref1 = Newnotes.Dimensions;
        results = [];
        for (name in ref1) {
          if (!hasProp.call(ref1, name)) continue;
          results.push(add_selector(name));
        }
        return results;
      };
      newnotes_note_action = function() {
        div(function() {
          a({
            href: '#',
            onclick: "Newnotes.panels[" + id + "].move(-1);"
          }, '▲');
          a({
            href: '#',
            onclick: "Newnotes.panels[" + id + "].dent('out');"
          }, '◄');
          a({
            href: '#',
            onclick: "Newnotes.panels[" + id + "].home();"
          }, 'Home');
          a({
            href: '#',
            onclick: "Newnotes.panels[" + id + "].new();"
          }, 'New');
          a({
            href: '#',
            onclick: "Newnotes.panels[" + id + "].sort();"
          }, 'Sort');
          a({
            href: '#',
            onclick: "Newnotes.panels[" + id + "].dent('in');"
          }, '►');
          return a({
            href: '#',
            onclick: "Newnotes.panels[" + id + "].move(1);"
          }, '▼');
        });
        return div(function() {
          a({
            href: '#',
            onclick: "Newnotes.panels[" + id + "].open();"
          }, 'Develop');
          a({
            href: '#',
            onclick: "Newnotes.panels[" + id + "].close();"
          }, 'Open');
          a({
            href: '#',
            onclick: "Newnotes.panels[" + id + "].toggle();"
          }, 'Toggle');
          a({
            href: '#',
            onclick: "Newnotes.panels[" + id + "].compact();"
          }, 'Compact');
          return a({
            href: '#',
            onclick: "Newnotes.panels[" + id + "].expand();"
          }, 'Expand');
        });
      };
      newnotes_note_attributes = function() {
        var add_selector, name, ref1, results;
        add_selector = (function(_this) {
          return function(name) {
            return select(("#newnotes-" + id + "-" + (name.toLowerCase()) + "-select") + css_class, {
              onchange: "Newnotes.panels[" + id + "].on_option_selected('" + name + "', this);"
            }, '');
          };
        })(this);
        ref1 = Newnotes.Dimensions;
        results = [];
        for (name in ref1) {
          if (!hasProp.call(ref1, name)) continue;
          results.push(add_selector(name));
        }
        return results;
      };
      newnotes_note_input = function() {
        return span(function() {
          return (this.params.use_ace ? panel : textarea)("#newnotes-" + id + "-note-text-input", {
            style: 'background-color:white;width:0;height:0;',
            'data-ace-theme': this.params.ace_theme
          }, '');
        });
      };
      newnotes_note_history = function() {
        return div("#newnotes-" + id + "-history-body", function() {});
      };
      newnotes_note_memory = function() {
        return div("#newnotes-" + id + "-note-memory", function() {
          return text(' ');
        });
      };
      newnotes_note_message = function() {
        return body("#newnotes-" + id + "-note-message", function() {
          return text(' ');
        });
      };
      newnotes_log_buttons = function(options) {
        return div({
          style: ((options != null ? options.float : void 0) === true ? "float:right;" : "")
        }, function() {
          input("#newnotes-" + id + "-note-logoff.hidden", {
            type: 'button',
            onclick: "Newnotes.panels[" + id + "].logoff();",
            value: 'Logoff',
            style: "background-color:green; color:white;"
          });
          return input("#newnotes-" + id + "-note-logon.hidden", {
            type: 'button',
            onclick: "Newnotes.panels[" + id + "].switch_login(true);",
            value: 'Logon',
            style: "background-color:red; color:white;"
          });
        });
      };
      panel("#newnotes-" + id + "-login-panel.hidden", function() {
        return form(function() {
          text('Enter your key: ');
          input("#newnotes-" + id + "-login-key", {
            type: 'password'
          }, '');
          return input({
            type: 'submit',
            onclick: "Newnotes.panels[" + id + "].register_key(); return false;",
            value: 'Enter'
          });
        });
      });
      return panel("#newnotes-" + id + "-note-panel", function() {
        body("#." + this.params.taste, function() {
          switch (this.params.taste) {
            case 'fullscreen-wide':
              this.params.in_list = true;
              box("#.leather", function() {
                return box("#.stitch", function() {
                  return panel({
                    proportion: 'served'
                  }, function() {
                    panel(function() {
                      header({
                        by: 5
                      }, function() {
                        newnotes_filter();
                        newnotes_search();
                        return newnotes_note_memory();
                      });
                      return body(function() {
                        return newnotes_filter_list();
                      });
                    });
                    box(function() {
                      return panel(function() {
                        return newnotes_list();
                      });
                    });
                    return panel(function() {
                      header({
                        by: 10
                      }, function() {
                        newnotes_log_buttons({
                          float: true
                        });
                        newnotes_note_action();
                        return newnotes_note_attributes();
                      });
                      return body(function() {
                        return panel({
                          proportion: 'half-served',
                          orientation: 'vertical'
                        }, function() {
                          panel(function() {
                            return newnotes_note_history();
                          });
                          return panel(function() {
                            return newnotes_note_message();
                          });
                        });
                      });
                    });
                  });
                });
              });
              return newnotes_note_input();
            case 'fullscreen-narrow':
              this.params.in_list = true;
              panel('#.hidden', function() {
                newnotes_search();
                return newnotes_note_memory();
              });
              box("#.leather", function() {
                return box("#.stitch", function() {
                  return panel(function() {
                    header(function() {
                      return newnotes_filter();
                    });
                    return body(function() {
                      return panel({
                        proportion: 'half-served',
                        orientation: 'vertical'
                      }, function() {
                        box(function() {
                          return panel(function() {
                            newnotes_filter_list({
                              hidden: true
                            });
                            return newnotes_list();
                          });
                        });
                        return panel(function() {
                          header({
                            by: 2
                          }, function() {
                            return newnotes_note_action();
                          });
                          return footer(function() {
                            return newnotes_log_buttons();
                          });
                        });
                      });
                    });
                  });
                });
              });
              panel('#.hidden', function() {
                return newnotes_note_attributes();
              });
              return newnotes_note_input();
            default:
              this.params.in_list = false;
              return panel({
                orientation: 'vertical',
                proportion: 'half-served'
              }, function() {
                panel(function() {
                  header({
                    by: 3
                  }, function() {
                    return body(function() {
                      newnotes_filter();
                      newnotes_search();
                      return newnotes_note_memory();
                    });
                  });
                  newnotes_filter_list({
                    hidden: true
                  });
                  return newnotes_list();
                });
                return panel(function() {
                  header({
                    by: 3
                  }, function() {
                    return box(function() {
                      return body(function() {
                        newnotes_note_action();
                        return newnotes_note_attributes();
                      });
                    });
                  });
                  return body(function() {
                    return box('#.' + css_class, function() {
                      return body(function() {
                        return newnotes_note_input(true);
                      });
                    });
                  });
                });
              });
          }
        });
        script('_id = ' + id + ';' + '_url = ' + JSON.stringify(this.params.url) + ';' + '_in_list = ' + this.params.in_list + ';' + '_has_keyboard = ' + this.params.has_keyboard + ';' + '_use_ace = ' + this.params.use_ace + ';' + '_standalone = ' + this.params.standalone + ';');
        return coffeescript(function() {
          return Newnotes.panels.push(new Newnotes.HtmlPanel(new Newnotes, _id, _url, _in_list, _has_keyboard, _use_ace, _standalone));
        });
      });
    };

    _Class.Dimensions = {
      Priority: {
        values: ['Now', 'Tomorrow', 'Later', 'Done']
      },
      Scope: {
        values: ['Me', 'Household', 'Family', 'Friends', 'Community', 'Business', 'State', 'Public'],
        node: 'free'
      },
      Action: {
        values: ['Explore', 'Memorize', 'Learn', 'Teach', 'Discuss', 'Do', 'Control', 'Delegate', 'Relax'],
        node: 'free'
      },
      Intention: {
        values: ['Know', 'Use', 'Make', 'Manage'],
        node: 'free'
      },
      Wish: {
        values: ['No wish', 'Identity', 'Hobbies', 'Education', 'Religion', 'Leisure'],
        node: 'free'
      },
      Need: {
        values: ['No need', 'Food', 'Health', 'Clothing', 'Equipment', 'Housing'],
        node: 'free'
      },
      Share: {
        values: ['No share', 'Communication', 'Partnership', 'Work', 'Finance', 'Insurance'],
        node: 'free'
      }
    };

    _Class.HtmlPanel = (function() {
      function _Class(newnotes1, id1, url, in_list, has_keyboard, use_ace, standalone) {
        var Mode, ace_theme, cache, commands, input_box, ref, start;
        this.newnotes = newnotes1;
        this.id = id1;
        this.url = url;
        this.in_list = in_list;
        this.has_keyboard = has_keyboard;
        this.use_ace = use_ace;
        this.standalone = standalone;
        this.switch_login = bind(this.switch_login, this);
        this.editor = new ((function() {
          function _Class() {}

          _Class.prototype.get = function() {
            if (this.use_ace) {
              return this._.getSession().getValue();
            } else {
              return this._.get('value');
            }
          };

          _Class.prototype.set = function(value) {
            if (this.use_ace) {
              return this._.getSession().setValue(value);
            } else {
              return this._.set('value', value);
            }
          };

          _Class.prototype.focus = function() {
            this._.focus();
            if (this.use_ace) {
              return this._.selectAll();
            } else {
              return this._.select();
            }
          };

          _Class.prototype.clear = function() {
            this.current_id = void 0;
            this.tree_states = {};
            return this.tree_navigate = {};
          };

          _Class.prototype.current_id = void 0;

          _Class.prototype.tree_states = {};

          _Class.prototype.tree_navigate = {};

          _Class.prototype.exporting = false;

          _Class.prototype.modified = false;

          _Class.prototype.waiting = false;

          _Class.prototype.editing = false;

          DOMEvent.defineKeys({
            '36': 'home',
            '35': 'end'
          });

          return _Class;

        })());
        if (this.use_ace) {
          this.editor.use_ace = true;
          this.editor._ = ace.edit("newnotes-" + this.id + "-note-text-input");
          this.editor._.setShowPrintMargin(false);
          this.editor._.renderer.setShowGutter(false);
          input_box = document.id("newnotes-" + this.id + "-note-text-input");
          ace_theme = (ref = input_box.attributes['data-ace-theme']) != null ? ref.value : void 0;
          if (ace_theme != null) {
            this.editor._.setTheme(ace_theme);
          }
          Mode = require('ace/mode/markdown').Mode;
          this.editor._.getSession().setMode(new Mode());
          this.editor._.getSession().on('change', (function(_this) {
            return function(e) {
              if (!_this.editor.editing) {
                return;
              }
              return _this[_this.editor.current_id != null ? 'save' : 'add'](!_this.in_list);
            };
          })(this));
          this.editor._.on('focus', (function(_this) {
            return function(e) {
              if (_this.editor._.container.getStyle('width') !== '0px') {
                return _this.editor.editing = true;
              }
            };
          })(this));
          this.editor._.on('blur', (function(_this) {
            return function(e) {
              return _this.editor.editing = false;
            };
          })(this));
          this.editor._.getSession().setUseWrapMode(true);
          this.editor._.getSession().setWrapLimitRange(null, null);
          commands = this.editor._.commands;
          commands.addCommand({
            name: "save_or_add",
            bindKey: {
              win: "Return",
              mac: "Return"
            },
            exec: (function(_this) {
              return function(editor) {
                var document, last_col, last_row, range;
                document = editor.getSession().getDocument();
                last_row = document.getLength() - 1;
                last_col = document.getLine(last_row).length;
                range = editor.getSelectionRange();
                if (!_this.editor.editing || range.isEnd(last_row, last_col)) {
                  return _this["new"]();
                } else {
                  return _this.editor._.insert('\n');
                }
              };
            })(this)
          });
          commands.addCommand({
            name: "save_or_add_prev",
            bindKey: {
              win: "Alt-Return",
              mac: "Alt-Return"
            },
            exec: (function(_this) {
              return function() {
                return _this["new"]({
                  before: true
                });
              };
            })(this)
          });
          commands.addCommand({
            name: "export",
            bindKey: {
              win: "Ctrl-S",
              mac: "Command-S"
            },
            exec: (function(_this) {
              return function() {
                return _this["export"]();
              };
            })(this)
          });
          commands.addCommand({
            name: "filter",
            bindKey: {
              win: "Ctrl-F",
              mac: "Command-F"
            },
            exec: (function(_this) {
              return function() {
                return _this.focus_filter();
              };
            })(this)
          });
          commands.addCommand({
            name: "indent",
            bindKey: {
              win: "Tab",
              mac: "Tab"
            },
            exec: (function(_this) {
              return function(editor) {
                var range;
                range = editor.getSelectionRange();
                if (range.isStart(0, 0)) {
                  _this.dent('in');
                  return editor.focus();
                } else {
                  return editor.indent();
                }
              };
            })(this),
            multiSelectAction: "forEach"
          });
          commands.addCommand({
            name: "outdent",
            bindKey: {
              win: "Shift-Tab",
              mac: "Shift-Tab"
            },
            exec: (function(_this) {
              return function(editor) {
                var range;
                range = editor.getSelectionRange();
                if (range.isStart(0, 0)) {
                  _this.dent('out');
                  return editor.focus();
                } else {
                  return editor.blockOutdent();
                }
              };
            })(this),
            multiSelectAction: "forEach"
          });
          commands.addCommand({
            name: "home",
            bindKey: {
              win: "Home",
              mac: "Home"
            },
            exec: (function(_this) {
              return function(editor, args) {
                _this.home();
                return editor.focus();
              };
            })(this)
          });
          commands.addCommand({
            name: "gotoleft",
            bindKey: {
              win: "Left",
              mac: "Left|Ctrl-B"
            },
            exec: (function(_this) {
              return function(editor, args) {
                if (!_this.editor.editing) {
                  _this.modify();
                  return _this.editor.focus();
                } else {
                  return editor.navigateLeft(args.times);
                }
              };
            })(this),
            multiSelectAction: "forEach",
            readOnly: true
          });
          commands.addCommand({
            name: "gotoright",
            bindKey: {
              win: "Right",
              mac: "Right|Ctrl-F"
            },
            exec: (function(_this) {
              return function(editor, args) {
                if (!_this.editor.editing) {
                  _this.modify();
                  return _this.editor.focus();
                } else {
                  return editor.navigateRight(args.times);
                }
              };
            })(this),
            multiSelectAction: "forEach",
            readOnly: true
          });
          commands.addCommand({
            name: "golineup",
            bindKey: {
              win: "Up",
              mac: "Up|Ctrl-P"
            },
            exec: (function(_this) {
              return function(editor, args) {
                var range;
                range = editor.getSelectionRange();
                if (range.isStart(0, 0)) {
                  return _this.navigate(-1);
                } else {
                  return editor.navigateUp(args.times);
                }
              };
            })(this),
            multiSelectAction: "forEach",
            readOnly: true
          });
          commands.addCommand({
            name: "golinedown",
            bindKey: {
              win: "Down",
              mac: "Down|Ctrl-N"
            },
            exec: (function(_this) {
              return function(editor, args) {
                var document, last_col, last_row, range;
                document = editor.getSession().getDocument();
                last_row = document.getLength() - 1;
                last_col = document.getLine(last_row).length;
                range = editor.getSelectionRange();
                if (range.isEnd(last_row, last_col)) {
                  return _this.navigate(1);
                } else {
                  return editor.navigateDown(args.times);
                }
              };
            })(this),
            multiSelectAction: "forEach",
            readOnly: true
          });
          commands.addCommand({
            name: "movelineup",
            bindKey: {
              win: "Ctrl-Up",
              mac: "Ctrl-Up"
            },
            exec: (function(_this) {
              return function(editor, args) {
                _this.move(-1);
                editor.focus();
                return true;
              };
            })(this)
          });
          commands.addCommand({
            name: "movelinedown",
            bindKey: {
              win: "Ctrl-Down",
              mac: "Ctrl-Down"
            },
            exec: (function(_this) {
              return function(editor, args) {
                _this.move(1);
                editor.focus();
                return true;
              };
            })(this)
          });
          commands.addCommand({
            name: "compact",
            bindKey: {
              win: "Ctrl-Shift-Up",
              mac: "Ctrl-Shift-Up"
            },
            exec: (function(_this) {
              return function(editor, args) {
                _this.open();
                editor.focus();
                return true;
              };
            })(this)
          });
          commands.addCommand({
            name: "expand",
            bindKey: {
              win: "Ctrl-Shift-Down",
              mac: "Ctrl-Shift-Down"
            },
            exec: (function(_this) {
              return function(editor, args) {
                _this.close();
                editor.focus();
                return true;
              };
            })(this)
          });
          commands.addCommand({
            name: "clear_filter",
            bindKey: {
              win: "Esc",
              mac: "Esc"
            },
            exec: (function(_this) {
              return function(editor, args) {
                _this.clear_filter();
                return editor.focus();
              };
            })(this)
          });
          commands.addCommand({
            name: "togglepriority_or_split_node_or_newline",
            bindKey: {
              win: "Ctrl-Return",
              mac: "Ctrl-Return"
            },
            exec: (function(_this) {
              return function(editor, args) {
                var document, last_col, last_row, range;
                if (!_this.editor.editing) {
                  _this.toggle_priority();
                  return editor.focus();
                } else {
                  document = editor.getSession().getDocument();
                  last_row = document.getLength() - 1;
                  last_col = document.getLine(last_row).length;
                  range = editor.getSelectionRange();
                  if (!range.isEnd(last_row, last_col)) {
                    _this.split();
                    return editor.focus();
                  } else {
                    return _this.editor._.insert('\n');
                  }
                }
              };
            })(this)
          });
          commands.addCommand({
            name: "toggle_or_newline",
            bindKey: {
              win: "Shift-Return",
              mac: "Shift-Return"
            },
            exec: (function(_this) {
              return function(editor, args) {
                var document, last_col, last_row, range;
                document = editor.getSession().getDocument();
                last_row = document.getLength() - 1;
                last_col = document.getLine(last_row).length;
                range = editor.getSelectionRange();
                if (range.isStart(0, 0) && range.isEnd(last_row, last_col)) {
                  _this.toggle();
                  _this.list();
                  editor.focus();
                  return true;
                } else {
                  return _this.editor._.insert('\n');
                }
              };
            })(this)
          });
          commands.addCommand({
            name: "pin",
            bindKey: {
              win: "Ctrl-Shift-Return",
              mac: "Ctrl-Shift-Return"
            },
            exec: (function(_this) {
              return function(editor, args) {
                if (!_this.editor.editing) {
                  _this.pin();
                  return editor.focus();
                }
              };
            })(this)
          });
        } else {
          this.editor.use_ace = false;
          this.editor._ = document.id("newnotes-" + this.id + "-note-text-input");
          this.editor._.addEvent('keyup', (function(_this) {
            return function(e) {
              if (!_this.editor.editing) {
                return;
              }
              return _this[_this.editor.current_id != null ? 'save' : 'add'](false);
            };
          })(this));
          this.editor._.addEvent('focus', (function(_this) {
            return function(e) {
              if (_this.editor._.container.getStyle('width') !== '0px') {
                return _this.editor.editing = true;
              }
            };
          })(this));
          this.editor._.addEvent('blur', (function(_this) {
            return function(e) {
              _this.editor.editing = false;
              return _this.list();
            };
          })(this));
          this.editor._.container = this.editor._;
          this.editor._.container.dispose();
        }
        start = (function(_this) {
          return function() {
            _this.check_connected();
            setInterval((function() {
              return _this.check_connected();
            }), 1 * 60 * 1000);
            return _this.reload();
          };
        })(this);
        cache = window.applicationCache;
        if (this.standalone) {
          window.addEventListener('load', function(e) {
            cache.addEventListener('updateready', function(e) {
              if (cache.status === cache.UPDATEREADY) {
                cache.swapCache();
                return window.location.reload();
              } else {

              }
            }, false);
            cache.addEventListener('cached', (function(e) {
              return start();
            }), false);
            cache.addEventListener('noupdate', (function(e) {
              return start();
            }), false);
            return cache.addEventListener('error', (function(e) {
              return start();
            }), false);
          }, false);
        } else {
          start();
        }
      }

      _Class.prototype.current_get = function() {
        return this.newnotes.data.by.id[this.editor.current_id];
      };

      _Class.prototype.current_set = function(id) {
        var note, results;
        this.editor.current_id = id;
        this.newnotes.path = [];
        if (id != null) {
          note = this.newnotes.data.by.id[id];
          this.newnotes.path.push(id);
          results = [];
          while ((note = note.parent) != null) {
            results.push(this.newnotes.path.unshift(note.uuid));
          }
          return results;
        }
      };

      _Class.prototype.register_key = function() {
        var ref;
        if (((ref = this.url) != null ? ref.register_key : void 0) != null) {
          return new Request({
            data: {
              key: document.id("newnotes-" + this.id + "-login-key").value
            },
            noCache: true,
            url: this.url.register_key,
            onSuccess: (function(_this) {
              return function(data) {
                _this.switch_login(false);
                return _this.check_connected();
              };
            })(this),
            onFailure: function(xhr) {}
          }).post();
        }
      };

      _Class.prototype.logoff = function() {
        var ref;
        if (((ref = this.url) != null ? ref.forget_keys : void 0) != null) {
          return new Request({
            url: this.url.forget_keys,
            noCache: true,
            onSuccess: (function(_this) {
              return function(data) {
                _this.switch_login(true);
                return _this.check_connected();
              };
            })(this),
            onFailure: function(xhr) {}
          }).post();
        }
      };

      _Class.prototype.switch_login = function(switched) {
        if (document.id("newnotes-" + this.id + "-" + (switched === true ? 'login' : 'note') + "-panel").hasClass('hidden')) {
          document.id("newnotes-" + this.id + "-note-panel")[(switched === true ? 'add' : 'remove') + "Class"]('hidden');
          document.id("newnotes-" + this.id + "-login-panel")[(switched === true ? 'remove' : 'add') + "Class"]('hidden');
          if (!switched) {
            return this.reload();
          }
        }
      };

      _Class.prototype.data_modified_date = void 0;

      _Class.prototype.get_data_modified_date = function() {
        if (this.is_connected) {
          return new Request({
            url: this.url.modified_date,
            noCache: true,
            onSuccess: (function(_this) {
              return function(responseText) {
                var value;
                if (responseText !== '') {
                  value = parseInt(responseText);
                  if (_this.data_modified_date == null) {
                    _this.data_modified_date = value;
                  }
                  if (value > _this.data_modified_date) {
                    _this.data_modified_date = value;
                    return window.location.reload();
                  }
                }
              };
            })(this),
            onFailure: function(xhr) {}
          }).get();
        }
      };

      _Class.prototype.is_connected = false;

      _Class.prototype.check_connected = function() {
        var ref, switch_log;
        switch_log = (function(_this) {
          return function(switched) {
            _this.is_connected = !switched;
            document.id("newnotes-" + _this.id + "-note-log" + (switched === true ? 'on' : 'off')).removeClass('hidden');
            document.id("newnotes-" + _this.id + "-note-log" + (switched === true ? 'off' : 'on')).addClass('hidden');
            if (_this.is_connected) {
              setTimeout((function() {
                return _this.get_data_modified_date.call(_this);
              }), 100);
            }
            return document.id("newnotes-" + _this.id + "-list-body")[(switched ? 'add' : 'remove') + 'Class']('disconnected');
          };
        })(this);
        if (((ref = this.url) != null ? ref.connected : void 0) != null) {
          return new Request({
            url: this.url.connected,
            noCache: true,
            onSuccess: function(data) {
              if (data === "connected") {
                return switch_log(false);
              } else {
                return switch_log(true);
              }
            },
            onFailure: function(xhr) {
              return switch_log(true);
            }
          }).get();
        }
      };

      _Class.prototype['new'] = function(option) {
        var note;
        this.remove_if_empty();
        note = this.newnotes.add('', ((option != null ? option.at_end : void 0) ? void 0 : this.current_get()), ((option != null ? option.before : void 0) ? 0 : 1));
        this.on_tagging_change(note);
        this.current_set(note.uuid);
        this.editor.set('');
        this.on_note_modified();
        return this.modify();
      };

      _Class.prototype.add = function() {
        var note;
        note = this.newnotes.add(this.editor.get());
        this.on_tagging_change(note);
        this.current_set(note.uuid);
        this.list();
        return this.on_note_modified();
      };

      _Class.prototype.split = function() {
        var Range, del_range, del_text, document, last_col, last_row, pos;
        document = this.editor._.getSession().getDocument();
        last_row = document.getLength() - 1;
        last_col = document.getLine(last_row).length;
        pos = this.editor._.getCursorPosition();
        Range = require('ace/range').Range;
        del_range = new Range(pos.row, pos.column, last_row, last_col);
        del_text = this.editor._.getSession().getTextRange(del_range);
        this.editor._.getSession().remove(del_range);
        this["new"]();
        return this.editor._.setValue(del_text);
      };

      _Class.prototype.sort = function() {
        var note;
        note = this.current_get();
        this.newnotes.sort(note);
        this.list();
        return this.on_note_modified();
      };

      _Class.prototype.dent = function(direction) {
        var note, parent, result;
        note = this.current_get();
        parent = note.parent;
        this.newnotes[direction + 'dent'](note);
        result = [];
        result.push(this.on_tagging_change(note));
        if (parent != null) {
          result.push(this.on_tagging_change(parent, true));
        }
        if (indexOf.call(result, true) < 0) {
          this.list();
          return this.on_note_modified();
        }
      };

      _Class.prototype.move = function(step) {
        this.newnotes.move(this.current_get(), step);
        this.list();
        return this.on_note_modified();
      };

      _Class.prototype.remove_if_empty = function() {
        var note;
        note = this.current_get();
        if ((note != null ? note.title : void 0) === '' && note.subs.length === 0) {
          this.newnotes.remove(note);
          this.on_tagging_change(note);
          this.newnotes.path = [];
          this.on_note_modified();
          return true;
        } else {
          return false;
        }
      };

      _Class.prototype.set_dimension = function(option, value, note, dolist, propagate) {
        if (dolist == null) {
          dolist = true;
        }
        if (propagate == null) {
          propagate = true;
        }
        if (note != null) {
          this.save(false, option, value, note);
          if (propagate) {
            this.on_tagging_change(note, void 0, false);
          }
          this.on_note_modified();
          if (dolist) {
            this.list();
          }
        }
        return this.newnotes.dimensions[option].value = value;
      };

      _Class.prototype.toggle_priority = function(item, index) {
        var dimension, id, note, value;
        id = item != null ? item.attributes['data-uuid'].value : this.current_get().uuid;
        note = this.newnotes.data.by.id[id];
        if ((note != null ? note.subs.length : void 0) > 0) {
          return;
        }
        dimension = 'Priority';
        if (index == null) {
          index = Newnotes.Dimensions.Priority.values.indexOf(note.dimensions[dimension]) + 1;
        }
        if (index >= Newnotes.Dimensions[dimension].values.length) {
          index = 0;
        }
        value = Newnotes.Dimensions[dimension].values[index];
        this.set_dimension(dimension, value, note);
        document.id("newnotes-" + this.id + "-" + (dimension.toLowerCase()) + "-select").value = value;
        this.on_note_modified();
        this.list();
        return this.editor.focus();
      };

      _Class.prototype.save = function(dolist, option, value, note) {
        if (note == null) {
          note = this.current_get();
        }
        if (option == null) {
          this.newnotes.modify(note, this.editor.get());
        } else {
          this.newnotes.modify(note, option, value);
        }
        if (dolist !== false) {
          this.list();
        }
        if (window.event.type !== 'click') {
          return this.on_note_modified();
        }
      };

      _Class.prototype.load = function(callback) {
        var ref;
        if (((ref = this.url) != null ? ref.load : void 0) != null) {
          return new Request.JSON({
            url: this.url.load,
            onSuccess: (function(_this) {
              return function(data) {
                var i, j, key, l, len1, len2, name, note, ref1, ref2, ref3, ref4, ref5, ref6, uuid;
                if (data != null) {
                  ref1 = data.by.id;
                  for (uuid in ref1) {
                    if (!hasProp.call(ref1, uuid)) continue;
                    note = ref1[uuid];
                    data.by.id[uuid] = Newnotes.Note.create(note);
                  }
                  ref2 = data.by.id;
                  for (uuid in ref2) {
                    if (!hasProp.call(ref2, uuid)) continue;
                    note = ref2[uuid];
                    Newnotes.Note.awake(note, data);
                  }
                  ref3 = data.by.root;
                  for (i = j = 0, len1 = ref3.length; j < len1; i = ++j) {
                    uuid = ref3[i];
                    data.by.root[i] = data.by.id[uuid];
                  }
                  ref4 = Newnotes.Dimensions;
                  for (name in ref4) {
                    if (!hasProp.call(ref4, name)) continue;
                    ref5 = data.by[name];
                    for (key in ref5) {
                      if (!hasProp.call(ref5, key)) continue;
                      ref6 = data.by[name][key];
                      for (i = l = 0, len2 = ref6.length; l < len2; i = ++l) {
                        uuid = ref6[i];
                        data.by[name][key][i] = data.by.id[uuid];
                      }
                    }
                  }
                  _this.newnotes.data = data;
                  if (data.by.root.length === 0) {
                    _this.newnotes.add('new Note !');
                  }
                  return typeof callback === "function" ? callback() : void 0;
                }
              };
            })(this),
            onFailure: function(xhr) {}
          }).get();
        }
      };

      _Class.prototype.reload = function() {
        return this.load((function(_this) {
          return function() {
            var name, ref;
            _this.list();
            _this.fill_search_selector();
            ref = Newnotes.Dimensions;
            for (name in ref) {
              if (!hasProp.call(ref, name)) continue;
              document.id("newnotes-" + _this.id + "-" + (name.toLowerCase()) + "-select").set('html', _this.html_options("" + name));
            }
            _this.editor._.resize();
            return _this.editor.focus();
          };
        })(this));
      };

      _Class.prototype["export"] = function() {
        var base, data, item, j, key, l, len1, len2, name, note, ref, ref1, ref2, ref3, ref4, ref5, uuid;
        if (this.remove_if_empty()) {
          this.list();
        }
        data = Newnotes.new_data();
        ref = this.newnotes.data.by.id;
        for (uuid in ref) {
          if (!hasProp.call(ref, uuid)) continue;
          note = ref[uuid];
          data.by.id[uuid] = note["export"]();
        }
        ref1 = this.newnotes.data.by.root;
        for (j = 0, len1 = ref1.length; j < len1; j++) {
          item = ref1[j];
          data.by.root.push(item.uuid);
        }
        ref2 = Newnotes.Dimensions;
        for (name in ref2) {
          if (!hasProp.call(ref2, name)) continue;
          ref3 = this.newnotes.data.by[name];
          for (key in ref3) {
            if (!hasProp.call(ref3, key)) continue;
            ref4 = this.newnotes.data.by[name][key];
            for (l = 0, len2 = ref4.length; l < len2; l++) {
              item = ref4[l];
              ((base = data.by[name])[key] != null ? base[key] : base[key] = []).push(item.uuid);
            }
          }
        }
        if (((ref5 = this.url) != null ? ref5.save : void 0) != null) {
          this.editor.exporting = true;
          return new Request.JSON({
            url: this.url.save,
            onSuccess: (function(_this) {
              return function() {
                _this.editor.exporting = false;
                _this.data_modified_date = void 0;
                return setTimeout((function() {
                  return _this.get_data_modified_date.call(_this);
                }), 100);
              };
            })(this),
            onFailure: function(xhr) {}
          }).post(JSON.stringify(data));
        }
      };

      _Class.prototype.display_message = function(message) {
        return new Element('div').set('html', ('<p>' + new Date().toString('dd/MM/yyyy HH:mm:ss')) + '<br/>&nbsp;&nbsp;' + message + '</p>').inject(document.id("newnotes-" + this.id + "-note-message"), 'top');
      };

      _Class.prototype.list = function() {
        var is_editing, kup, line_count, line_height, list_body, list_panel, new_element, new_height, ref, ref1, scroll_pos;
        kup = function() {
          var nav;
          nav = this.params.editor.tree_navigate;
          nav.previous = nav.current = nav.next = void 0;
          kup = function(selection) {
            var base, bullet, bullet_char, classes, compacted_title, index, is_compacted, item, j, len1, name1, priority, regexp, results, selected, state, str_content, str_title;
            if (selection == null) {
              selection = this.params.selection;
            }
            if (this.params.filter.text != null) {
              if (selection.filtered.first != null) {
                if (this.params.filter.last_filter !== this.params.filter.text) {
                  this.params.editor.current_id = this.params.filter.first = selection.filtered.first;
                  this.params.filter.last_filter = this.params.filter.text;
                }
              }
            } else {
              if (this.params.filter.last_filter != null) {
                this.params.filter.last_filter = this.params.filter.first = void 0;
              }
            }
            if (this.params.filter.text != null) {
              regexp = new RegExp(this.params.filter.text, 'ig');
            }
            results = [];
            for (index = j = 0, len1 = selection.length; j < len1; index = ++j) {
              item = selection[index];
              if (this.params.editor.current_id === void 0) {
                this.params.editor.current_id = item.note.uuid;
              }
              if ((base = this.params.editor.tree_states)[name1 = item.note.uuid] == null) {
                base[name1] = {
                  node: false,
                  closed: (item.note.subs.length > 0 ? true : false),
                  compacted: (item.filtered ? false : true)
                };
              }
              selected = this.params.editor.current_id === item.note.uuid;
              state = this.params.editor.tree_states[item.note.uuid];
              if (state.new_closed_state != null) {
                this.params.editor.new_closed_subs_state = state.new_closed_state;
              }
              if (state.new_compacted_state != null) {
                this.params.editor.new_compacted_subs_state = state.new_compacted_state;
              }
              if (this.params.editor.new_closed_subs_state != null) {
                state.closed = state.new_closed_state != null ? false : this.params.editor.new_closed_subs_state;
              }
              if (this.params.editor.new_compacted_subs_state != null) {
                state.compacted = this.params.editor.new_compacted_subs_state;
              }
              is_compacted = false;
              str_title = item.note.title;
              str_content = void 0;
              if (state.compacted) {
                compacted_title = Newnotes.Note.compact_title(item.note, {
                  with_content: true
                });
                str_title = compacted_title.title;
                str_content = compacted_title.content;
                is_compacted = compacted_title.is_compacted;
              }
              str_title = new Chocodown.converter().makeHtml(str_title);
              if (str_title.slice(0, 3) === '<p>') {
                str_title = str_title.slice(3);
              }
              if (str_title.slice(-4) === '</p>') {
                str_title = str_title.slice(0, -4);
              }
              if (str_content != null) {
                str_content = new Chocodown.converter().makeHtml(str_content);
                if (str_content.slice(0, 3) === '<p>') {
                  str_content = str_content.slice(3);
                }
                if (str_content.slice(-4) === '</p>') {
                  str_content = str_content.slice(0, -4);
                }
              }
              if (item.filtered) {
                str_title = str_title.replace(regexp, "<span class='newnotes-filtered'>$&</span>");
              }
              state.filtered = item.filtered;
              if (item.subs.filtered.exists) {
                state.closed = false;
              }
              state.node = item.note.subs.length > 0;
              if (item.filtered || (this.params.filter.text == null)) {
                if (!((nav.next != null) || (nav.current == null))) {
                  nav.next = item.note.uuid;
                }
                if (selected) {
                  nav.current = item.note.uuid;
                }
                if (nav.current == null) {
                  nav.previous = item.note.uuid;
                }
              }
              bullet = state.node ? (state.closed ? '+' : '-') : '>';
              bullet_char = item.subs.length > 0 ? '•' : '●';
              priority = item.note.dimensions.Priority != null ? "<span class='newnotes-priority-" + item.note.dimensions.Priority + "'>" + bullet_char + "</span>" : '';
              classes = ['note'];
              if (selected) {
                classes.push('selected');
              }
              if (is_compacted) {
                classes.push('compacted');
              }
              li({
                'class': classes.join(' '),
                'data-uuid': item.note.uuid,
                onclick: "Newnotes.panels[" + this.params.id + "].modify(this);"
              }, function() {
                span({
                  'data-uuid': item.note.uuid,
                  onclick: "Newnotes.panels[" + this.params.id + "].toggle(this);Newnotes.panels[" + this.params.id + "].modify(this, {no_focus:true});window.event.stopPropagation();"
                }, bullet);
                span({
                  'data-uuid': item.note.uuid,
                  onclick: "Newnotes.panels[" + this.params.id + "].toggle_priority(this);Newnotes.panels[" + this.params.id + "].modify(this, {no_focus:true});window.event.stopPropagation();"
                }, ' ' + priority);
                text('  ' + str_title);
                if (is_compacted) {
                  a({
                    href: '#',
                    'data-uuid': item.note.uuid,
                    onclick: "Newnotes.panels[" + this.params.id + "].expand(this);"
                  }, '...');
                }
                if (str_content != null) {
                  return p('  ' + str_content);
                }
              });
              if (item.subs.length > 0 && !state.closed) {
                ul(function() {
                  return kup.call(this, item.subs);
                });
              }
              if (state.new_closed_state != null) {
                state.new_closed_state = this.params.editor.new_closed_subs_state = void 0;
              }
              if (state.new_compacted_state != null) {
                results.push(state.new_compacted_state = this.params.editor.new_compacted_subs_state = void 0);
              } else {
                results.push(void 0);
              }
            }
            return results;
          };
          return kup.call(this);
        };
        is_editing = this.editor.editing;
        list_body = document.id("newnotes-" + this.id + "-list-body");
        list_panel = document.id("newnotes-" + this.id + "-list-panel");
        list_panel.setStyle('display', '');
        list_panel.set('html', new Chocokup.Panel({
          editor: this.editor,
          id: this.id,
          selection: this.newnotes.select(void 0, this.current_get()),
          filter: this.newnotes.filter
        }, kup).render());
        this.editor.editing = is_editing;
        new_element = list_body.getElement("li[data-uuid=" + this.editor.current_id + "]");
        if (new_element != null) {
          while (new_element.getPosition(list_body).y + new_element.getSize().y - 1 > list_body.getSize().y / 2 + new_element.getSize().y / 2) {
            scroll_pos = list_body.getScroll().y;
            list_body.scrollTo(0, list_body.getScroll().y + (new_element.getPosition(list_body).y + new_element.getSize().y - list_body.getSize().y / 2 - new_element.getSize().y / 2));
            if (list_body.getScroll().y === scroll_pos) {
              break;
            }
          }
          while (new_element.getPosition(list_body).y + 1 < list_body.getSize().y / 2 - new_element.getSize().y / 2) {
            scroll_pos = list_body.getScroll().y;
            list_body.scrollTo(0, list_body.getScroll().y - (list_body.getSize().y / 2 - new_element.getSize().y / 2 - new_element.getPosition(list_body).y));
            if (list_body.getScroll().y === scroll_pos) {
              break;
            }
          }
          if (this.in_list === false) {
            this.editor._.container.setStyle('width', '100%');
            return this.editor._.container.setStyle('height', '100%');
          } else {
            if (is_editing) {
              if (this.has_keyboard) {
                this.editor._.container.setStyle('position', 'relative');
                this.editor._.container.setStyle('left', '24px');
                this.editor._.container.setStyle('top', '-14px');
                this.editor._.container.setStyle('margin-bottom', '-19px');
                this.editor._.container.setStyle('width', new_element.getSize().x - 30);
                line_count = 1 + ((ref = (ref1 = this.current_get().title.match(/\n/g)) != null ? ref1.length : void 0) != null ? ref : 0);
                line_height = parseFloat(new_element.getComputedStyle('line-height'));
                new_height = Math.max(line_count * line_height, new_element.getSize().y);
                this.editor._.container.setStyle('height', new_height + "px");
                new_element.setStyle('height', new_height + "px");
                this.editor._.container.inject(new_element, 'after');
              } else {
                list_panel.setStyle('display', 'none');
                this.editor._.container.setStyle('position', 'absolute');
                this.editor._.container.setStyle('left', '0px');
                this.editor._.container.setStyle('top', '0px');
                this.editor._.container.setStyle('width', '100%');
                this.editor._.container.setStyle('height', '100%');
                this.editor._.container.setStyle('font-size', '1em');
                this.editor._.container.inject(list_body, 'after');
              }
              new_element.setStyle('overflow', 'hidden');
              new_element.setStyle('width', '20px');
              new_element.setStyle('height', '7px');
              if (this.use_ace) {
                return this.editor._.resize();
              }
            } else {
              if (this.use_ace) {
                this.editor._.container.setStyle('position', 'absolute');
                this.editor._.container.setStyle('left', 0);
                this.editor._.container.setStyle('top', 0);
                this.editor._.container.setStyle('width', 0);
                this.editor._.container.setStyle('height', 0);
                return this.editor._.container.inject(new_element, 'after');
              } else {
                return this.editor._.container.dispose();
              }
            }
          }
        }
      };

      _Class.prototype.modify = function(item, options) {
        var id, name, note, ref, value;
        id = item != null ? item.attributes['data-uuid'].value : this.editor.current_id;
        if ((id != null) && id === this.editor.current_id || !this.in_list) {
          if (!(options != null ? options.no_focus : void 0)) {
            this.editor.editing = true;
          }
        } else {
          this.remove_if_empty();
        }
        this.current_set(id);
        note = this.current_get();
        this.editor.set(note.title);
        ref = Newnotes.Dimensions;
        for (name in ref) {
          if (!hasProp.call(ref, name)) continue;
          value = note.dimensions[name];
          document.id("newnotes-" + this.id + "-" + (name.toLowerCase()) + "-select").value = value;
          this.newnotes.dimensions[name].value = value;
        }
        this.list();
        if (!(options != null ? options.no_focus : void 0)) {
          return this.editor.focus();
        }
      };

      _Class.prototype.open = function(item) {
        var id, ref;
        id = item != null ? item.attributes['data-uuid'].value : (ref = this.current_get()) != null ? ref.uuid : void 0;
        if (id != null) {
          this.editor.tree_states[id].new_closed_state = false;
          this.editor.tree_states[id].new_compacted_state = false;
          return this.list();
        }
      };

      _Class.prototype.close = function(item) {
        var id, note, ref;
        id = item != null ? item.attributes['data-uuid'].value : (ref = this.current_get()) != null ? ref.uuid : void 0;
        if (id != null) {
          note = this.newnotes.data.by.id[id];
          this.editor.tree_states[id].new_closed_state = true;
          this.editor.tree_states[id].new_compacted_state = note.subs.length > 0 ? true : false;
          return this.list();
        }
      };

      _Class.prototype.expand = function(item) {
        var id, ref;
        id = item != null ? item.attributes['data-uuid'].value : (ref = this.current_get()) != null ? ref.uuid : void 0;
        if (id != null) {
          this.editor.tree_states[id].new_compacted_state = false;
          return this.list();
        }
      };

      _Class.prototype.compact = function(item) {
        var id, ref;
        id = item != null ? item.attributes['data-uuid'].value : (ref = this.current_get()) != null ? ref.uuid : void 0;
        if (id != null) {
          this.editor.tree_states[id].new_compacted_state = true;
          return this.list();
        }
      };

      _Class.prototype.home = function() {
        this.switch_filter_list(false);
        this.clear_filter();
        this.clear_pin();
        this.editor.clear();
        this.list();
        return this.editor.focus();
      };

      _Class.prototype.navigate = function(step) {
        var dest_id, item;
        dest_id = this.editor.tree_navigate[step > 0 ? 'next' : 'previous'];
        if (dest_id != null) {
          item = document.id("newnotes-" + this.id + "-list-body").getElement("li[data-uuid=" + dest_id + "]");
        }
        if (item != null) {
          this.editor.editing = false;
          return this.modify(item);
        }
      };

      _Class.prototype.toggle = function(item) {
        var id, note, ref;
        id = item != null ? item.attributes['data-uuid'].value : this.current_get().uuid;
        note = this.newnotes.data.by.id[id];
        if ((ref = this.editor.tree_states[id]) != null ? ref.node : void 0) {
          this.editor.tree_states[id].closed = !this.editor.tree_states[id].closed;
        } else {
          this.editor.tree_states[id].compacted = !this.editor.tree_states[id].compacted;
        }
        return this.list();
      };

      _Class.prototype.focus_filter = function() {
        var item;
        item = document.id("newnotes-" + this.id + "-filter-input");
        return item.focus();
      };

      _Class.prototype.clear_filter = function() {
        var item;
        item = document.id("newnotes-" + this.id + "-filter-input");
        item.value = '';
        this.filter(item);
        return this.list();
      };

      _Class.prototype.init_filter = function() {
        this.clear_filter();
        return this.focus_filter();
      };

      _Class.prototype.stop_filter = function() {
        this.newnotes.filter.text = void 0;
        return this.list();
      };

      _Class.prototype.start_filter = function() {
        var item;
        item = document.id("newnotes-" + this.id + "-filter-input");
        if (item.value !== this.newnotes.filter.text && item.value !== "") {
          this.newnotes.filter.text = item.value;
          return this.list();
        }
      };

      _Class.prototype.filter = function(item) {
        this.newnotes.filter.set(item.value !== '' ? item.value : void 0);
        if (item.value !== '') {
          this.current_set(void 0);
        }
        this.filter_list();
        return this.list();
      };

      _Class.prototype.filter_list = function() {
        var kup, list_body;
        kup = function() {
          kup = function(selection) {
            var close_left, close_right, close_size, found, i, index, item, j, len, len1, match, regexp, results, str, trail_left, trail_right;
            if (selection == null) {
              selection = this.params.selection;
            }
            results = [];
            for (index = j = 0, len1 = selection.length; j < len1; index = ++j) {
              item = selection[index];
              if (item.filtered) {
                str = item.note.title;
                regexp = new RegExp(this.params.filter.text, "ig");
                while (match = regexp.exec(str)) {
                  i = match.index;
                  len = this.params.filter.text.length;
                  close_size = 40;
                  trail_left = i - close_size > 0 ? '...' : '';
                  trail_right = i + len + close_size < str.length ? '...' : '';
                  close_left = str.substr((trail_left === '' ? 0 : i - close_size), (trail_left === '' ? i : close_size));
                  close_right = str.substr(i + len, close_size);
                  found = str.substr(i, len);
                  div({
                    'data-uuid': item.note.uuid,
                    onclick: "Newnotes.panels[" + this.params.id + "].go(this);"
                  }, function() {
                    return trail_left + close_left + "<span class='newnotes-filtered'>" + found + "</span>" + close_right + trail_right;
                  });
                }
              }
              if (item.subs.length > 0) {
                results.push(kup.call(this, item.subs));
              } else {
                results.push(void 0);
              }
            }
            return results;
          };
          return kup.call(this);
        };
        list_body = document.id("newnotes-" + this.id + "-filter-list-body");
        return list_body.set('html', new Chocokup.Panel({
          editor: this.editor,
          id: this.id,
          selection: this.newnotes.select(),
          filter: this.newnotes.filter
        }, kup).render());
      };

      _Class.prototype.go = function(item) {
        var id;
        this.switch_filter_list(false);
        this.start_filter();
        id = item != null ? item.attributes['data-uuid'].value : this.current_get().uuid;
        this.current_set(id);
        this.list();
        return this.editor.focus();
      };

      _Class.prototype.clear_pin = function() {
        this.newnotes.clear_pin();
        document.id("newnotes-" + this.id + "-pin-list").set('html', 'None');
        this.current_set(void 0);
        this.filter_list();
        return this.list();
      };

      _Class.prototype.pin = function(force) {
        this.newnotes.pin(this.current_get(), force);
        return this.on_pinned();
      };

      _Class.prototype.unpin = function(item) {
        var id, note;
        id = item != null ? item.attributes['data-uuid'].value : this.current_get().uuid;
        note = this.newnotes.data.by.id[id];
        this.newnotes.unpin(note);
        return this.on_pinned();
      };

      _Class.prototype.on_note_modified = function() {
        var check;
        if (this.editor.waiting) {
          this.editor.modified = true;
          return;
        }
        check = (function(_this) {
          return function() {
            if (_this.editor.modified || _this.editor.exporting) {
              _this.editor.modified = false;
              return setTimeout(check, 3000);
            } else {
              _this["export"]();
              return _this.editor.waiting = false;
            }
          };
        })(this);
        this.editor.waiting = true;
        return setTimeout(check, 3000);
      };

      _Class.prototype.on_key_filter = function(item) {
        var event, key;
        event = void 0;
        key = window.event != null ? (event = new DOMEvent(window.event)).key : '';
        switch (key) {
          case 'up':
            return this.navigate(-1);
          case 'down':
            return this.navigate(1);
          case 'esc':
            this.clear_filter();
            return this.editor.focus();
          case 'home':
            return this.home();
          case 'enter':
            if (event.shift && event.control) {
              this.pin();
              this.clear_filter();
              return this.editor.focus();
            }
            break;
          default:
            if (item.value.length >= 3 || item.value.length === 0) {
              return this.filter(item);
            }
        }
      };

      _Class.prototype.switch_filter_list = function(switched) {
        var filter_list, list;
        list = document.id("newnotes-" + this.id + "-list-main");
        filter_list = document.id("newnotes-" + this.id + "-filter-list-main");
        if ((switched ? filter_list : list).hasClass('hidden')) {
          filter_list[(switched ? 'remove' : 'add') + "Class"]('hidden');
          return list[(switched ? 'add' : 'remove') + "Class"]('hidden');
        }
      };

      _Class.prototype.on_filter_focus = function() {
        this.switch_filter_list(true);
        return this.start_filter();
      };

      _Class.prototype.on_pinned = function() {
        var html;
        html = (new Chocokup({
          id: this.id,
          selected: this.newnotes.pinned.selected
        }, function() {
          var i, j, len1, note, ref, results;
          ref = this.params.selected;
          results = [];
          for (i = j = 0, len1 = ref.length; j < len1; i = ++j) {
            note = ref[i];
            text(i > 0 ? ', ' : '');
            results.push(a({
              href: "#",
              'data-uuid': note.uuid,
              onclick: "Newnotes.panels[" + this.params.id + "].unpin(this);"
            }, (note.title.length > 8 ? note.title.substr(0, 5) + '...' : note.title)));
          }
          return results;
        })).render({
          format: false
        });
        document.id("newnotes-" + this.id + "-pin-list").set('html', html === '' ? 'None' : html);
        this.current_set(void 0);
        this.filter_list();
        this.list();
        return this.editor.focus();
      };

      _Class.prototype.on_pin_mode_changed = function(item) {
        this.newnotes.pinned.mode = item.value;
        this.current_set(void 0);
        this.filter_list();
        this.list();
        return this.editor.focus();
      };

      _Class.prototype.on_option_selected = function(option, select, note, level) {
        var j, len1, ref, sub;
        if (level == null) {
          level = 0;
        }
        if (note == null) {
          note = this.current_get();
        }
        if ((note != null ? note.subs.length : void 0) > 0) {
          if (Newnotes.Dimensions[option].node !== 'free') {
            this.set_dimension(option, select.value, note, false, false);
            ref = note.subs;
            for (j = 0, len1 = ref.length; j < len1; j++) {
              sub = ref[j];
              this.on_option_selected(option, select, sub, level + 1);
            }
            if (level === 0) {
              this.on_tagging_change(note, void 0, true);
              this.editor.focus();
            }
            return;
          }
        }
        this.set_dimension(option, select.value, note, false, false);
        if (level === 0) {
          this.on_tagging_change(note, void 0, true);
          return this.editor.focus();
        }
      };

      _Class.prototype.on_search_option_selected = function(option, select) {
        this.newnotes.dimensions[option].searched = select.value;
        if (select.value !== 'all') {
          document.id("newnotes-" + this.id + "-" + (option.toLowerCase()) + "-select").value = select.value;
          this.newnotes.dimensions[option].value = select.value;
        }
        this.current_set(void 0);
        this.list();
        this.filter_list();
        return this.editor.focus();
      };

      _Class.prototype.on_tagging_change = function(note, do_self, dolist) {
        var check, modified;
        if (dolist == null) {
          dolist = true;
        }
        check = (function(_this) {
          return function(note, check_self) {
            var base, dimension, index, item, item_index, j, len1, list, modified, name, parent, ref, value;
            modified = false;
            parent = !check_self ? note.parent : note;
            ref = Newnotes.Dimensions;
            for (name in ref) {
              if (!hasProp.call(ref, name)) continue;
              dimension = ref[name];
              if (dimension.node !== 'free') {
                index = dimension.values.length;
                if ((list = parent != null ? parent.subs : void 0) != null) {
                  for (j = 0, len1 = list.length; j < len1; j++) {
                    item = list[j];
                    item_index = dimension.values.indexOf(item.dimensions[name]);
                    if (item_index < index) {
                      value = item.dimensions[name];
                      _this.newnotes.data.by[name][parent.dimensions[name]].erase(parent);
                      parent.dimensions[name] = value;
                      ((base = _this.newnotes.data.by[name])[value] != null ? base[value] : base[value] = []).push(parent);
                      index = item_index;
                      modified = true;
                    }
                  }
                }
              }
            }
            if ((parent != null) && modified) {
              check(parent);
            }
            return modified;
          };
        })(this);
        if (modified = check(note, do_self)) {
          if (dolist) {
            this.list();
          }
        }
        this.fill_search_selector();
        return modified;
      };

      _Class.prototype.html_options = function(name, selected, count) {
        return (new Chocokup({
          option: Newnotes.Dimensions[name].values,
          selected: selected,
          count: count != null ? count : false,
          by: this.newnotes.data.by[name]
        }, function() {
          var id, j, len1, ref, ref1, ref2, results;
          ref = this.params.option;
          results = [];
          for (j = 0, len1 = ref.length; j < len1; j++) {
            id = ref[j];
            results.push(option({
              value: id,
              selected: this.params.selected === id
            }, id + (this.params.count ? " (" + ((ref1 = (ref2 = this.params.by[id]) != null ? ref2.length : void 0) != null ? ref1 : 0) + ")" : '')));
          }
          return results;
        })).render();
      };

      _Class.prototype.fill_search_selector = function() {
        var name, ref, results, selector;
        ref = Newnotes.Dimensions;
        results = [];
        for (name in ref) {
          if (!hasProp.call(ref, name)) continue;
          selector = document.id("newnotes-" + this.id + "-search-" + (name.toLowerCase()) + "-select");
          results.push(selector.set('html', "<option value='all'>All</option>" + this.html_options("" + name, selector.value, true)));
        }
        return results;
      };

      return _Class;

    })();

    _Class.Note = (function() {
      function _Class(title1, parent1, dimensions1, uuid1) {
        this.title = title1;
        this.parent = parent1;
        this.dimensions = dimensions1;
        this.uuid = uuid1 != null ? uuid1 : _.Uuid();
        this.subs = [];
        this.date = {
          creation: new Date(),
          modified: new Date()
        };
      }

      _Class.compact_title = function(note, options) {
        var line_break_index, result;
        result = {
          title: note.title,
          content: void 0,
          is_compacted: false
        };
        line_break_index = note.title.indexOf('\n');
        if (line_break_index <= 0) {
          line_break_index = 160;
        }
        if ((0 < line_break_index && line_break_index < note.title.length)) {
          result.title = note.title.substr(0, line_break_index);
          if (options != null ? options.with_content : void 0) {
            result.content = note.title.substr(line_break_index);
          }
          result.is_compacted = true;
        }
        return result;
      };

      _Class.prototype["export"] = function() {
        var item, j, len1, note, ref;
        note = new Newnotes.Note(this.title, this.parent, Newnotes.clone(this.dimensions), this.uuid);
        if (note.parent != null) {
          note.parent = note.parent.uuid;
        }
        ref = this.subs;
        for (j = 0, len1 = ref.length; j < len1; j++) {
          item = ref[j];
          note.subs.push(item.uuid);
        }
        note.date = {
          creation: this.date.creation,
          modified: this.date.modified
        };
        return note;
      };

      _Class.create = function(item) {
        var i, j, len1, note, ref, uuid;
        note = new Newnotes.Note(item.title, item.parent, Newnotes.clone(item.dimensions), item.uuid);
        ref = item.subs;
        for (i = j = 0, len1 = ref.length; j < len1; i = ++j) {
          uuid = ref[i];
          note.subs[i] = uuid;
        }
        note.date = {
          creation: new Date(Date.parse(item.date.creation)),
          modified: new Date(Date.parse(item.date.modified))
        };
        return note;
      };

      _Class.awake = function(item, data) {
        var i, j, len1, ref, uuid;
        if (item.parent != null) {
          item.parent = data.by.id[item.parent];
        }
        ref = item.subs;
        for (i = j = 0, len1 = ref.length; j < len1; i = ++j) {
          uuid = ref[i];
          item.subs[i] = data.by.id[uuid];
        }
        return item;
      };

      return _Class;

    })();

    _Class.panels = [];

    _Class.create_panel = function(options) {
      options.has_keyboard = Browser.Platform.mac || Browser.Platform.win || Browser.Platform.linux;
      options.use_ace = ace && options.has_keyboard ? true : false;
      options.code_css = Highlight.defaultCodeCSS;
      return new Chocokup.Panel(options, Newnotes.kup).render().stripScripts(function(scripts, html) {
        document.id(options.element_id).set('html', html);
        return Browser.exec(scripts);
      });
    };

    _Class.clone = function(object) {
      var cloned, key;
      if (!((object != null) && typeof object === "object")) {
        return object;
      }
      cloned = new object.constructor;
      for (key in object) {
        cloned[key] = Newnotes.clone(object[key]);
      }
      return cloned;
    };

    _Class.new_data = function() {
      var data, name, ref;
      data = {
        by: {
          id: {},
          root: []
        }
      };
      ref = Newnotes.Dimensions;
      for (name in ref) {
        if (!hasProp.call(ref, name)) continue;
        data.by[name] = {};
      }
      return data;
    };

    function _Class() {
      this.path = [];
      this.filter = {
        text: void 0,
        first: void 0,
        last_filter: void 0,
        set: function(text) {
          this.text = text;
          return this.first = this.last_filter = void 0;
        }
      };
      this.pinned = {
        mode: 'on',
        selected: [],
        used: []
      };
      this.selection = [];
      this.dimensions = (function() {
        var dimension, dimensions, name, ref;
        dimensions = {};
        ref = Newnotes.Dimensions;
        for (name in ref) {
          if (!hasProp.call(ref, name)) continue;
          dimension = ref[name];
          dimensions[name] = {
            value: dimension.values[0],
            searched: 'all'
          };
        }
        return dimensions;
      })();
      this.data = Newnotes.new_data();
    }

    _Class.prototype.clear = function() {
      this.data = Newnotes.new_data();
    };

    _Class.prototype.add = function(title, after, step) {
      var base, dimension, index, item, j, len1, list, name, name1, note, parent, ref, ref1;
      if (step == null) {
        step = -1;
      }
      parent = this.path.length > 0 ? this.data.by.id[this.path.getLast()].parent : void 0;
      note = new Newnotes.Note(title, parent, (function(_this) {
        return function() {
          var dimensions, k, ref, v;
          dimensions = {};
          ref = _this.dimensions;
          for (k in ref) {
            if (!hasProp.call(ref, k)) continue;
            v = ref[k];
            dimensions[k] = v.value;
          }
          return dimensions;
        };
      })(this)());
      list = (ref = parent != null ? parent.subs : void 0) != null ? ref : this.data.by.root;
      if (after != null) {
        for (index = j = 0, len1 = list.length; j < len1; index = ++j) {
          item = list[index];
          if (item === after) {
            list.splice(index + step, 0, note);
            break;
          }
        }
      } else {
        list.push(note);
      }
      this.data.by.id[note.uuid] = note;
      ref1 = this.dimensions;
      for (name in ref1) {
        if (!hasProp.call(ref1, name)) continue;
        dimension = ref1[name];
        ((base = this.data.by[name])[name1 = dimension.value] != null ? base[name1] : base[name1] = []).push(note);
      }
      return note;
    };

    _Class.prototype.sort = function(note) {
      var compare, j, len1, ref, results, sub;
      compare = function(note1, note2) {
        var result;
        result = Newnotes.Dimensions.Priority.values.indexOf(note1.dimensions.Priority);
        result -= Newnotes.Dimensions.Priority.values.indexOf(note2.dimensions.Priority);
        if (result === 0) {
          result = note1.date.modified - note2.date.modified;
        }
        if (result < 0) {
          return -1;
        }
        if (result > 0) {
          return 1;
        }
      };
      if (note.subs.length > 0) {
        note.subs.sort(compare);
        ref = note.subs;
        results = [];
        for (j = 0, len1 = ref.length; j < len1; j++) {
          sub = ref[j];
          results.push(this.sort(sub));
        }
        return results;
      }
    };

    _Class.prototype.modify = function(note, option, value) {
      var base, name1;
      if ((option != null) && (value == null)) {
        if (note.title !== option) {
          note.title = option;
          note.date.modified = new Date();
        }
        return;
      }
      if ((option != null) && (value != null)) {
        if (note.dimensions[option] !== value) {
          this.data.by[option][note.dimensions[option]].erase(note);
          note.dimensions[option] = value;
          ((base = this.data.by[option])[name1 = note.dimensions[option]] != null ? base[name1] : base[name1] = []).push(note);
          note.date.modified = new Date();
        }
      }
    };

    _Class.prototype.remove = function(note) {
      var dimension, name, ref;
      if (note.parent != null) {
        note.parent.subs.erase(note);
      }
      delete this.data.by.id[note.uuid];
      ref = this.dimensions;
      for (name in ref) {
        if (!hasProp.call(ref, name)) continue;
        dimension = ref[name];
        this.data.by[name][note.dimensions[name]].erase(note);
      }
      if (!note.parent) {
        return this.data.by.root.erase(note);
      }
    };

    _Class.prototype.move = function(note, step) {
      var index, list, new_index, ref, ref1;
      list = (ref = (ref1 = note.parent) != null ? ref1.subs : void 0) != null ? ref : this.data.by.root;
      index = list.indexOf(note);
      new_index = index + step;
      if ((0 <= new_index && new_index < list.length)) {
        list.erase(note);
        list.splice(new_index, 0, note);
        return note.date.modified = new Date();
      }
    };

    _Class.prototype.indent = function(note) {
      var item, j, len1, list, previous, ref, ref1;
      list = (ref = (ref1 = note.parent) != null ? ref1.subs : void 0) != null ? ref : this.data.by.root;
      for (j = 0, len1 = list.length; j < len1; j++) {
        item = list[j];
        if (item === note) {
          break;
        } else {
          previous = item;
        }
      }
      if (previous != null) {
        list.erase(note);
        previous.subs.push(note);
        note.parent = previous;
        return note.date.modified = new Date();
      }
    };

    _Class.prototype.outdent = function(note) {
      var index, item, j, len1, list, parent, ref;
      if (note.parent != null) {
        note.parent.subs.erase(note);
        parent = note.parent.parent;
        list = (ref = parent != null ? parent.subs : void 0) != null ? ref : this.data.by.root;
        for (index = j = 0, len1 = list.length; j < len1; index = ++j) {
          item = list[index];
          if (item === note.parent) {
            list.splice(index + 1, 0, note);
            break;
          }
        }
        note.parent = parent;
        return note.date.modified = new Date();
      }
    };

    _Class.prototype.is_inside = function(item, parent) {
      if (item === parent) {
        return true;
      } else {
        if (item.parent != null) {
          return this.is_inside(item.parent, parent);
        }
      }
      return false;
    };

    _Class.prototype.pin = function(note, force) {
      var i, is_usable, j, l, len1, len2, pinned, ref, ref1;
      if (indexOf.call(this.pinned.selected, note) >= 0 && !force) {
        return;
      }
      if (indexOf.call(this.pinned.selected, note) < 0) {
        this.pinned.selected.push(note);
      }
      ref = this.pinned.used;
      for (i = j = 0, len1 = ref.length; j < len1; i = ++j) {
        pinned = ref[i];
        if (this.is_inside(note, pinned)) {
          this.pinned.used.splice(i, 1);
          break;
        }
      }
      is_usable = true;
      ref1 = this.pinned.used;
      for (l = 0, len2 = ref1.length; l < len2; l++) {
        pinned = ref1[l];
        if (this.is_inside(pinned, note)) {
          is_usable = false;
        }
      }
      if (is_usable) {
        return this.pinned.used.push(note);
      }
    };

    _Class.prototype.unpin = function(note) {
      var i, item, j, l, len1, len2, ref, results, to_pin;
      i = this.pinned.used.indexOf(note);
      if (i >= 0) {
        this.pinned.used.splice(i, 1);
      }
      i = this.pinned.selected.indexOf(note);
      if (i >= 0) {
        this.pinned.selected.splice(i, 1);
      }
      to_pin = [];
      ref = this.pinned.selected;
      for (j = 0, len1 = ref.length; j < len1; j++) {
        item = ref[j];
        if (indexOf.call(this.pinned.used, item) < 0) {
          if (this.is_inside(note, item)) {
            to_pin.push(item);
          }
        }
      }
      results = [];
      for (l = 0, len2 = to_pin.length; l < len2; l++) {
        item = to_pin[l];
        results.push(this.pin(item, true));
      }
      return results;
    };

    _Class.prototype.clear_pin = function() {
      this.pinned.used = [];
      return this.pinned.selected = [];
    };

    _Class.prototype.list = function() {
      var id, note, ref;
      this.selection = [];
      ref = this.data.by.id;
      for (id in ref) {
        if (!hasProp.call(ref, id)) continue;
        note = ref[id];
        this.selection.push(note);
      }
      return this.selection;
    };

    _Class.prototype.select = function(parent, current) {
      var base, base1, dimension, filtered, j, keep_note, len1, list, name, note, ref, ref1, ref2, ref3, regexp, selection, subs;
      selection = [];
      selection.filtered = {
        exists: false,
        first: void 0
      };
      subs = {
        selection: void 0,
        select: (function(_this) {
          return function(note, current) {
            var ref;
            return (ref = subs.selection) != null ? ref : subs.selection = _this.select(note, current);
          };
        })(this)
      };
      if (this.filter.text != null) {
        regexp = new RegExp(this.filter.text, 'ig');
      }
      list = (ref = (ref1 = parent != null ? parent.subs : void 0) != null ? ref1 : (this.pinned.mode === 'on' && this.pinned.used.length > 0 ? this.pinned.used : void 0)) != null ? ref : this.data.by.root;
      for (j = 0, len1 = list.length; j < len1; j++) {
        note = list[j];
        keep_note = true;
        subs.selection = void 0;
        ref2 = this.dimensions;
        for (name in ref2) {
          if (!hasProp.call(ref2, name)) continue;
          dimension = ref2[name];
          keep_note && (keep_note = (ref3 = dimension.searched) === note.dimensions[name] || ref3 === 'all');
        }
        keep_note || (keep_note = subs.select(note, current).length > 0);
        if (note.uuid === (current != null ? current.uuid : void 0)) {
          keep_note = true;
        }
        if (keep_note) {
          if (regexp != null) {
            filtered = !!note.title.match(regexp);
          }
          if ((base = selection.filtered).first == null) {
            base.first = filtered ? note.uuid : subs.select(note, current).filtered.first;
          }
          (base1 = selection.filtered).exists || (base1.exists = filtered || subs.select(note, current).filtered.exists);
          selection.push({
            note: note,
            subs: subs.select(note, current),
            filtered: filtered
          });
        }
      }
      if (parent == null) {
        this.selection = selection;
      }
      return selection;
    };

    _Class.connected = function() {
      return "connected";
    };

    _Class.disconnected = function() {
      return "disconnected";
    };

    _Class["interface"] = function(__) {
      return Newnotes.enter(__);
    };

    _Class.enter = function(__) {
      var stats;
      Chocokup = require('./chocokup');
      stats = require('fs').statSync(require.resolve('../general/newnotes.coffee'));
      return new Chocokup.App('Newnotes', {
        theme: 'basic',
        with_coffee: true,
        manifest: "/-/general/newnotes?manifest&how=manifest",
        appdir: __.appdir
      }, function() {
        style({
          type: "text/css",
          media: "screen"
        }, "body {\n    font-family:Lucida Console,Helvetica,monospace;\n    font-size:9pt;\n    background-color:white;\n    color:black;\n}\na, select {\n    color:black;\n}");
        text('<script>_sofkey = ' + (backdoor_key !== '' ? '"' + backdoor_key + '"' : 'null') + ("; _appdir = '" + this.params.appdir + "';") + '</script>\n');
        script({
          src: "/static/vendor/ace/ace.js",
          type: "text/javascript",
          charset: "utf-8"
        });
        script({
          src: "/static/vendor/ace/mode-coffee.js",
          type: "text/javascript",
          charset: "utf-8"
        });
        script({
          src: "/static/vendor/ace/mode-markdown.js",
          type: "text/javascript",
          charset: "utf-8"
        });
        script({
          src: "/static/vendor/ace/theme-chrome.js",
          type: "text/javascript",
          charset: "utf-8"
        });
        script({
          src: "/static/vendor/mootools/mootools-core-uncompressed.js",
          type: "text/javascript",
          charset: "utf-8"
        });
        script({
          src: "/static/lib/newnotes.js",
          type: "text/javascript",
          charset: "utf-8"
        });
        body(function() {
          return panel('#notes-panel', '');
        });
        return coffeescript(function() {
          var sofkey;
          sofkey = _sofkey;
          return window.addEvent('domready', function() {
            var connected, forget_keys, load, modified_date, ping, register_key, save, taste;
            window.addEvent('resize', function() {});
            taste = window.getSize().x < 640 ? 'fullscreen-narrow' : 'fullscreen-wide';
            load = '/' + (sofkey != null ? '!/' + sofkey : '') + 'data/newnotes_data.json?how=raw';
            save = '/' + (sofkey != null ? '!/' + sofkey : '') + 'data/newnotes_data.json?so=move&how=raw';
            connected = '/' + (sofkey != null ? '!/' + sofkey : '') + '-/general/newnotes?connected&how=raw';
            modified_date = '/' + (sofkey != null ? '!/' + sofkey : '') + '-/server/file?getModifiedDate&' + 'data/newnotes_data.json&how=raw';
            ping = '/' + (sofkey != null ? '!/' + sofkey : '') + '-/ping?how=raw';
            register_key = '/' + (sofkey != null ? '!/' + sofkey : '') + '-/server/interface?register_key&how=raw';
            forget_keys = '/' + (sofkey != null ? '!/' + sofkey : '') + '-/server/interface?forget_keys&how=raw';
            return Newnotes.create_panel({
              element_id: 'notes-panel',
              url: {
                load: load,
                save: save,
                connected: connected,
                modified_date: modified_date,
                ping: ping,
                register_key: register_key,
                forget_keys: forget_keys
              },
              taste: taste,
              standalone: true,
              ace_theme: 'ace/theme/chrome'
            });
          });
        });
      });
    };

    _Class.manifest = function(__) {
      var filename, fs, j, l, len1, len2, line, ref, stats, time_stamps, time_stamps_list, to_cache, to_cache_list;
      Chocokup = require('./chocokup');
      to_cache = Chocokup.App.manifest.cache + "\n/static/vendor/ace/ace.js\n/static/vendor/ace/mode-coffee.js\n/static/vendor/ace/mode-markdown.js\n/static/vendor/ace/theme-chrome.js\n/static/lib/coffeekup.js\n/static/lib/chocokup.js\n/static/lib/chocodown.js\n/static/vendor/mootools/mootools-core-uncompressed.js\n/static/lib/newnotes.js\n/data/newnotes_data.json?how=raw";
      to_cache_list = [];
      ref = to_cache.split('\n');
      for (j = 0, len1 = ref.length; j < len1; j++) {
        line = ref[j];
        to_cache_list.push((line.split('?'))[0].replace('/-', ''));
      }
      time_stamps_list = [];
      fs = require('fs');
      for (l = 0, len2 = to_cache_list.length; l < len2; l++) {
        filename = to_cache_list[l];
        stats = fs.statSync(require.resolve('..' + filename));
        time_stamps_list.push('#' + filename + ' : ' + stats.mtime.getTime());
      }
      time_stamps = time_stamps_list.join('\n');
      return "CACHE MANIFEST\n# v0.05.009\n# Files Timestamp\n#\n" + time_stamps + "\n\nCACHE:\n" + to_cache + "\n\nNETWORK:\n/static/lib/\n/-/ping\n/-/server/file?getModifiedDate\n\nFALLBACK:\n/-/general/newnotes?connected /-/general/newnotes?disconnected\n";
    };

    _Class.present = function(where, as, type, __) {
      var data, i, impress_html, impress_kup, iterate, j, key, kup, l, len1, len2, len3, m, name, note, paper_html, paper_kup, ref, ref1, ref2, ref3, ref4, ref5, ref6, result, returns, search, slides_html, slides_kup, str, title_compacted, uuid;
      if (typeof window !== "undefined" && window !== null) {
        return '';
      }
      data = JSON.parse(require('fs').readFileSync(require.resolve('../' + __.datadir + '/newnotes_data.json')));
      ref = data.by.id;
      for (uuid in ref) {
        note = ref[uuid];
        data.by.id[uuid] = Newnotes.Note.create(note);
      }
      if (Chocodown.Chocokup == null) {
        Chocodown.Chocokup = Chocokup;
      }
      if (Chocodown.Highlight == null) {
        Chocodown.Highlight = Highlight;
      }
      ref1 = data.by.id;
      for (uuid in ref1) {
        if (!hasProp.call(ref1, uuid)) continue;
        note = ref1[uuid];
        Newnotes.Note.awake(note, data);
        str = new Chocodown.converter().makeHtml(note.title);
        if (str.slice(0, 3) === '<p>') {
          str = str.slice(3);
        }
        if (str.slice(-4) === '</p>') {
          str = str.slice(0, -4);
        }
        note.html_title = str;
        title_compacted = Newnotes.Note.compact_title(note, {
          with_content: true
        });
        note.title_compacted = title_compacted.title;
        if (title_compacted.content != null) {
          note.html_title_content = new Chocodown.converter().makeHtml(title_compacted.content);
        }
      }
      ref2 = data.by.root;
      for (i = j = 0, len1 = ref2.length; j < len1; i = ++j) {
        uuid = ref2[i];
        data.by.root[i] = data.by.id[uuid];
      }
      ref3 = Newnotes.Dimensions;
      for (name in ref3) {
        if (!hasProp.call(ref3, name)) continue;
        ref4 = data.by[name];
        for (key in ref4) {
          if (!hasProp.call(ref4, key)) continue;
          ref5 = data.by[name][key];
          for (i = l = 0, len2 = ref5.length; l < len2; i = ++l) {
            uuid = ref5[i];
            data.by[name][key][i] = data.by.id[uuid];
          }
        }
      }
      search = function(what, note) {
        var len3, m, ref6, result, sub;
        if (note.title === what) {
          return note;
        } else {
          ref6 = note.subs;
          for (m = 0, len3 = ref6.length; m < len3; m++) {
            sub = ref6[m];
            result = search(what, sub);
            if (result != null) {
              return result;
            }
          }
        }
      };
      ref6 = data.by.root;
      for (m = 0, len3 = ref6.length; m < len3; m++) {
        note = ref6[m];
        result = search(where, note);
        if (result != null) {
          switch (as) {
            case 'json':
              data = Newnotes.new_data();
              iterate = function(uuid, note) {
                var base, ref7, ref8, results, sub;
                if (data.by.id[uuid] == null) {
                  data.by.id[uuid] = note["export"]();
                  ref7 = note.dimensions;
                  for (name in ref7) {
                    if (!hasProp.call(ref7, name)) continue;
                    key = ref7[name];
                    ((base = data.by[name])[key] != null ? base[key] : base[key] = []).push(uuid);
                  }
                  ref8 = note.subs;
                  results = [];
                  for (i in ref8) {
                    if (!hasProp.call(ref8, i)) continue;
                    sub = ref8[i];
                    results.push(iterate(sub.uuid, sub));
                  }
                  return results;
                }
              };
              data.by.root.push(result.uuid);
              iterate(result.uuid, result);
              return JSON.stringify(data);
            case 'paper':
              kup = function() {
                var count_points;
                type = this.params.type;
                count_points = function(note, level, css, sub_css) {
                  var nb, nbli, points;
                  if (level === 0) {
                    return div('.quiz.points', "Total points: " + iterate.quiz_total_point);
                  } else {
                    nb = note.subs.length;
                    if (css === '.leaf' || css === '.node' && sub_css === '.node') {
                      return;
                    }
                    points = (function() {
                      switch (false) {
                        case nb !== 0:
                          nbli = note.title.split('<br>').length;
                          switch (false) {
                            case !(nbli < 6):
                              return 1;
                            case !(nbli < 11):
                              return 2;
                            default:
                              return 5;
                          }
                          break;
                        case !(nb < 4):
                          return 0.5;
                        case !(nb < 8):
                          return 1;
                        case !(nb < 12):
                          return 1;
                        default:
                          return 2;
                      }
                    })();
                    div('.quiz.points', points + " point" + (points > 1 ? 's' : ''));
                    if (iterate.quiz_total_point == null) {
                      iterate.quiz_total_point = 0;
                    }
                    return iterate.quiz_total_point += points;
                  }
                };
                iterate = function(note, level, css) {
                  var ref7, sub, title;
                  if ((title = note.title)[0] === '$') {
                    ref7 = note.subs;
                    for (uuid in ref7) {
                      if (!hasProp.call(ref7, uuid)) continue;
                      sub = ref7[uuid];
                      iterate(sub, level + 1);
                    }
                    return;
                  }
                  if (title === '---') {
                    div({
                      style: "page-break-before:always"
                    }, function() {});
                    return;
                  }
                  if (title.substr(0, 3) === '===') {
                    div('.note', title.substr(3));
                    return;
                  }
                  return li("." + type + css, function() {
                    var ref8, size;
                    text(note.html_title);
                    if (((ref8 = note.subs) != null ? ref8.length : void 0) > 0) {
                      size = Math.max(16 - 2 * level, 12);
                      return ul({
                        style: "font-size:" + size + "pt"
                      }, function() {
                        var ref10, ref9, sub_css;
                        if (level === 0) {
                          sub_css = '.node';
                        } else {
                          sub_css = '.leaf';
                          ref9 = note.subs;
                          for (uuid in ref9) {
                            if (!hasProp.call(ref9, uuid)) continue;
                            sub = ref9[uuid];
                            if (sub.subs.length > 0) {
                              sub_css = '.node';
                            }
                          }
                        }
                        ref10 = note.subs;
                        for (uuid in ref10) {
                          if (!hasProp.call(ref10, uuid)) continue;
                          sub = ref10[uuid];
                          iterate(sub, level + 1, sub_css);
                        }
                        if (type === 'quiz') {
                          return count_points(note, level, css, sub_css);
                        }
                      });
                    } else if (type === 'quiz' && level > 0) {
                      return count_points(note, level, css, '');
                    }
                  });
                };
                return iterate(this.params.note, 0, '.root');
              };
              paper_html = new Chocokup.Panel({
                note: result,
                require: require,
                type: type
              }, kup).render();
              paper_kup = function() {
                style("li.quiz.leaf, li.quiz.root {\n    list-style: none;\n}\n\nli.quiz.node {\n    list-style: decimal;\n    margin-top: 1.5em;\n    margin-bottom: 1.5em;\n}\n\nli.quiz.node ul, div.note {\n    margin-top: 0.6em;\n}\n\nli.quiz.leaf:before {\n    content: '▢';\n}\n\ndiv.quiz.points {\n    margin-top: 0.8em;\n    font-size: 0.75em;\n}\n");
                return ul({
                  style: "font-size:20pt"
                }, function() {
                  return text("" + this.params.paper_html);
                });
              };
              return new Chocokup.Panel({
                paper_html: paper_html
              }, paper_kup).render();
            case 'impress':
              kup = function() {
                var impress, newnotes;
                impress = (function() {
                  function impress() {}

                  impress.prototype.x = 0;

                  impress.prototype.y = 0;

                  impress.prototype.z = 0;

                  impress.prototype.rx = 0;

                  impress.prototype.ry = 0;

                  impress.prototype.rz = 0;

                  impress.prototype.s = 1;

                  impress.prototype.stepped = {};

                  impress.prototype.defaults = {
                    move: void 0,
                    rotate: void 0,
                    scale: void 0,
                    css: {
                      'slide-style': {
                        how: 'to',
                        value: 'slide'
                      },
                      'overflow': {
                        how: 'to',
                        value: 'none'
                      }
                    }
                  };

                  impress.prototype.step = function() {
                    var _so, _what, ref7, so, what;
                    ref7 = this.defaults;
                    for (so in ref7) {
                      if (!hasProp.call(ref7, so)) continue;
                      _so = ref7[so];
                      if (_so != null) {
                        switch (so) {
                          case 'move':
                          case 'rotate':
                            for (what in _so) {
                              if (!hasProp.call(_so, what)) continue;
                              _what = _so[what];
                              if (!this.stepped[so + "-" + what]) {
                                this[so](what, _what.how, _what.value);
                              }
                            }
                            break;
                          case 'scale':
                            if (!this.stepped["scale"]) {
                              this.scale(_so.how, _so.value);
                            }
                        }
                      }
                    }
                    this.stepped = {};
                    return this;
                  };

                  impress.prototype.set = function(so, what, how, value) {
                    var _so, base;
                    if (!((so != null) && (what != null) && (how != null))) {
                      return;
                    }
                    _so = (base = this.defaults)[so] != null ? base[so] : base[so] = {};
                    if (value != null) {
                      return _so[what] = {
                        how: how,
                        value: value
                      };
                    } else {
                      return _so = {
                        how: what,
                        value: how
                      };
                    }
                  };

                  impress.prototype.move = function(what, how, value) {
                    this.stepped["move-" + what] = true;
                    return this[what] = (value != null ? parseInt(value) : 0) + (function() {
                      switch (how) {
                        case 'to':
                          return 0;
                        case 'by':
                          return this[what];
                        default:
                          return 0;
                      }
                    }).call(this);
                  };

                  impress.prototype.rotate = function(what, how, value) {
                    this.stepped["rotate-" + what] = true;
                    return this['r' + what] = (value != null ? parseInt(value) : 0) + (function() {
                      switch (how) {
                        case 'to':
                          return 0;
                        case 'by':
                          return this['r' + what];
                        default:
                          return 0;
                      }
                    }).call(this);
                  };

                  impress.prototype.scale = function(how, value) {
                    this.stepped["scale"] = true;
                    return this['s'] = (value != null ? parseInt(value) : 0) + (function() {
                      switch (how) {
                        case 'to':
                          return 0;
                        case 'by':
                          return this['s'];
                        default:
                          return 0;
                      }
                    }).call(this);
                  };

                  return impress;

                })();
                newnotes = {
                  impress: new impress(),
                  shell: 'impress'
                };
                this.params.returns.defaults = newnotes.impress.defaults;
                iterate = function(note, level) {
                  var command, defaults, exit, len4, line, lines, n, ref10, ref11, ref7, ref8, ref9, results, results1, rx, ry, rz, s, si, so, splits, sub, title, tool, x, y, z;
                  if ((title = note.title)[0] === '$') {
                    exit = true;
                    lines = (title.replace(/^\$\s*/, '')).split('\n');
                    for (n = 0, len4 = lines.length; n < len4; n++) {
                      line = lines[n];
                      if (!(line.search(/\S/) !== -1)) {
                        continue;
                      }
                      splits = line.split(' ');
                      si = 0;
                      tool = splits[si++];
                      if (tool !== 'impress') {
                        tool = newnotes.shell;
                        si = 0;
                      }
                      exit = false;
                      switch (tool) {
                        case 'impress':
                          switch (command = splits[si++]) {
                            case 'default':
                              newnotes.impress.set(splits[si++], splits[si++], splits[si++], splits[si++]);
                              exit = true;
                              break;
                            case void 0:
                              newnotes.shell = tool;
                              exit = true;
                              break;
                            default:
                              if ((so = newnotes.impress[command]) != null) {
                                if (typeof so.call === "function") {
                                  so.call(newnotes.impress, splits[si++], splits[si++], splits[si++]);
                                }
                                exit = true;
                              }
                          }
                      }
                    }
                    if (exit) {
                      ref7 = note.subs;
                      for (uuid in ref7) {
                        if (!hasProp.call(ref7, uuid)) continue;
                        sub = ref7[uuid];
                        iterate(sub, level + 1);
                      }
                      return;
                    }
                  }
                  switch (level) {
                    case 0:
                      ref8 = note.subs;
                      results = [];
                      for (uuid in ref8) {
                        if (!hasProp.call(ref8, uuid)) continue;
                        sub = ref8[uuid];
                        results.push(iterate(sub, level + 1));
                      }
                      return results;
                      break;
                    case 1:
                      ref9 = newnotes.impress.step(), x = ref9.x, y = ref9.y, z = ref9.z, rx = ref9.rx, ry = ref9.ry, rz = ref9.rz, s = ref9.s, defaults = ref9.defaults;
                      div({
                        "class": "step " + (defaults.css['slide-style'].value.split('.').join(' ')),
                        'data-scale': s,
                        'data-x': x,
                        'data-y': y,
                        'data-z': z,
                        'data-rotate-x': rx,
                        'data-rotate-y': ry,
                        'data-rotate-z': rz
                      }, function() {
                        return section(function() {
                          h2(note.title_compacted);
                          if (note.html_title_content != null) {
                            return text(note.html_title_content);
                          }
                        });
                      });
                      ref10 = note.subs;
                      results1 = [];
                      for (uuid in ref10) {
                        if (!hasProp.call(ref10, uuid)) continue;
                        sub = ref10[uuid];
                        results1.push(iterate(sub, level + 1));
                      }
                      return results1;
                      break;
                    case 2:
                      ref11 = newnotes.impress.step(), x = ref11.x, y = ref11.y, z = ref11.z, rx = ref11.rx, ry = ref11.ry, rz = ref11.rz, s = ref11.s, defaults = ref11.defaults;
                      return div({
                        "class": "step " + (defaults.css['slide-style'].value.split('.').join(' ')),
                        'data-scale': s,
                        'data-x': x,
                        'data-y': y,
                        'data-z': z,
                        'data-rotate-x': rx,
                        'data-rotate-y': ry,
                        'data-rotate-z': rz,
                        style: 'overflow-y:' + defaults.css['overflow'].value
                      }, function() {
                        header({
                          html5: true
                        }, function() {
                          return h1(note.title_compacted);
                        });
                        return section(function() {
                          var size;
                          if (note.html_title_content != null) {
                            text(note.html_title_content);
                          }
                          if (note.subs.length > 0) {
                            size = Math.max(40 - 4 * (level + 1), 10);
                            return ul({
                              style: "font-size:" + size + "pt"
                            }, function() {
                              var ref12, results2;
                              ref12 = note.subs;
                              results2 = [];
                              for (uuid in ref12) {
                                if (!hasProp.call(ref12, uuid)) continue;
                                sub = ref12[uuid];
                                results2.push(iterate(sub, level + 1));
                              }
                              return results2;
                            });
                          }
                        });
                      });
                    default:
                      return li(function() {
                        var size;
                        text(note.html_title);
                        if (note.subs.length > 0) {
                          size = Math.max(40 - 4 * (level + 1), 10);
                          return ul({
                            style: "font-size:" + size + "pt"
                          }, function() {
                            var ref12, results2;
                            ref12 = note.subs;
                            results2 = [];
                            for (uuid in ref12) {
                              if (!hasProp.call(ref12, uuid)) continue;
                              sub = ref12[uuid];
                              results2.push(iterate(sub, level + 1));
                            }
                            return results2;
                          });
                        }
                      });
                  }
                };
                return iterate(this.params.note, 0);
              };
              returns = {};
              impress_html = new Chocokup.Panel({
                note: result,
                returns: returns
              }, kup).render();
              impress_kup = function() {
                var ref7, ref8, ref9;
                return text("<html>\n<head>\n    <meta charset=\"utf-8\" />\n    <title>" + this.params.where + "</title>\n    <style>\n\n    .step {\n        position: relative;\n        width: 1160px;\n        padding: 40px;\n        margin: 20px auto;\n    \n        -webkit-box-sizing: border-box;\n        -moz-box-sizing:    border-box;\n        -ms-box-sizing:     border-box;\n        -o-box-sizing:      border-box;\n        box-sizing:         border-box;\n    \n        font-family: 'PT Serif', georgia, serif;\n        font-size: 36px;\n        line-height: 1.5;\n    }\n    \n    .step code {\n        font-size: 28;\n    }\n    \n    .impress-enabled .step {\n        margin: 0;\n        opacity: " + ((ref7 = (ref8 = this.params.css) != null ? (ref9 = ref8['inactive-opacity']) != null ? ref9.value : void 0 : void 0) != null ? ref7 : 0) + ";\n    \n        -webkit-transition: opacity 1s;\n        -moz-transition:    opacity 1s;\n        -ms-transition:     opacity 1s;\n        -o-transition:      opacity 1s;\n        transition:         opacity 1s;\n    }\n    \n    .impress-enabled .step.active { opacity: 1 }    \n\n    .slide {\n        display: block;\n    \n        width: 1160px;\n        height: 700px;\n        padding: 0px 60px;\n    \n        background-color: rgb(245, 240, 245);\n        border: 1px solid rgba(0, 0, 0, .3);\n        border-radius: 20px 60px;\n        box-shadow: 0 10px 50px rgba(255, 255, 205, .6);\n    \n        color: rgb(70, 70, 70);\n        text-shadow: 0 2px 2px rgba(0, 0, 0, .1);\n    }\n    \n    .slide.compact {\n        font-size: 32;\n        line-height: 1;\n    }\n    \n    .slide.wide {\n        height: 850px;\n    }\n    \n    .slide pre {\n        text-align: left;\n        font-family: 'Droid Sans Mono', Courier;\n        padding: 10px 20px;\n        background: rgba(255, 0, 0, 0.05);\n        -webkit-border-radius: 8px;\n        -khtml-border-radius: 8px;\n        -moz-border-radius: 8px;\n        border-radius: 8px;\n        border: 1px solid rgba(255, 0, 0, 0.2);\n    }\n    \n    a {\n        color: inherit;\n        text-decoration: none;\n        padding: 0 0.1em;\n        background: rgba(255,255,255,0.5);\n        text-shadow: -1px -1px 2px rgba(100,100,100,0.9);\n        border-radius: 0.2em;\n    \n        -webkit-transition: 0.5s;\n        -moz-transition:    0.5s;\n        -ms-transition:     0.5s;\n        -o-transition:      0.5s;\n        transition:         0.5s;\n    }\n    \n    a:hover,\n    a:focus {\n        background: rgba(255,255,255,1);\n        text-shadow: -1px -1px 2px rgba(100,100,100,0.5);\n    }\n    \n    body {\n        color:#eee;\n        background: url('data:image/jpeg;base64,/9j/4AAQSkZJRgABAgAAZABkAAD/7AARRHVja3kAAQAEAAAAWwAA/+4ADkFkb2JlAGTAAAAAAf/bAIQAAQEBAQEBAQEBAQIBAQECAgEBAQECAgICAgICAgMCAgICAgIDAwMDBAMDAwQEBQUEBAYGBgYGBwcHBwcHBwcHBwEBAQECAgIEAwMEBgUEBQYHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcH/8AAEQgD6AAQAwERAAIRAQMRAf/EAG8AAQEBAQEBAAAAAAAAAAAAAAMCAQQACgEBAQEBAQAAAAAAAAAAAAAAAAECAwQQAAICAQQCAQQCAwADAAAAAAECEQMAMUESBCFRE2Fx0TLBUvCBobEiQhEBAQEBAQEAAAAAAAAAAAAAABEBAhIh/9oADAMBAAIRAxEAPwD4YEoCPy5TGgz15y57pBYjMVDSRtmqkaLEZuIYEjYZKDSgI/PlPoffGYteShUfkDPoHGYu6UOjEqrAkbYqRodGYqGBYajCiShUcuDPoZMwUnXVH5hp1gYzAgdCSoaWG2XNFK6MxUNLbgYqCTrqjlw0+gdpyZgpOuEfnM/1H3y+UpQ6MxUMCw2y0aLEZioaWG2UHX11R+cz/UZPKqTrqjlwZ9D1OXOYpFdGYqGlhqMZqNDozFQ3/sNstWjTrqjlwSfQP1yZzNFV9da35gzrA++SM0odGYqGlhqBlGixGYqrSw2yEGnXCPzmf6jKKTrqj8wZj9QcRSB0ZioaWGowKWxGYqGkjUZao0661vz5TH6jJmFbX1lSwvyn0v3wlKHrdiisCw1GKlUtlbMVVgWGwwCr6y12Fw0+h98hqq+stdnMGYmB9/rmosMtlbMVVpYajCtFlbMVVgWGo84qDr6y12cwxMfqCPfs5IKTqqjl+ROsD1OEpRYjsVDgsNRgUtlbMVVgWGowQVfWWt+fImJ4j74gqvrLW/MNIH6jKsMtlbMUV5IwKWytmKq0sNhORBJ1VR+YaYniDtgqq+stdnMNMTxHqcpSrZWzFFaWGoxEjVsRmKq0sNRlA19Za7OYYmJ4j1OVaqvrLW/MMTE8QdpyRSrYjMVDSw1GKilsRmKhpYajDQq+utb8wZ9D1OIkanXWt+YJPoffNZypQ6MxUNJGowKV0ZioYFhqMVBJ1lR+YM68RkzEq066o5cEn0PWTMSkDozFQ0sNstGh0ZioaSNRlINOuqPzBn0PWXOSqr66o/MGf6jJDdIrozFA0sNQM1U0i2VsxVWBYajM1RV9Va3LhpH/AMr6yG7W19Za7OYYnWAdpy5hulWytmKq0sNQMYNFiMxVWkjbNZuJBp1hW/PlPpT9cznP1d1adUVvzDE6wPU5MxaVbK2YorSRqP8ANc1Ui1srZiqtLDbIga+stdnMMTrA++Iu62vrLXZzDT/URl8pTLZWzFVaWG2Mg1bK2YorSw1A/jLVHX1VrfnyJjRY021zOYlXX1Frs5hiYnise/ZwFW2p2KK8sNh/BwNW6t2KK8sNRlA1dVa7PkDExPFY0n64gqvqLXZ8gYmJ4r6n2cZhSrbW7FFcFhqMtFrbW7lFslxqB+d8lUNXTWqw2BiYnipgRP1xhuqq6a1W/IHJieK+p9nfIU63VO5rVwXGoH5wNW6p2KK4LLqMqAq6aVW/IGJieKnafrviLW1dNarTYGJ14r6nLCnW2p2ZFcFl1AyotbqndkVwzLPj7eveZI56uklVptDEjzxWNPzlKurpJVabAxOvBTtIjyd8yp1uqd2RXDONRhFLfS7mtXBcagfwd8RAU9FabflDkxPBCNJ8eTv4wVtPRSm35eZMTwWNJ8eTv4yldCX02Oa0cM66j7etskRSX02Oa0sDOuo/B3ypHNT0Upu+UOWAngpGk+PJ3xV3VU9BKbvlDkgTwWNJ8eTvirroS+mxzWlgZxqB+cJGpfS7tWtgZ11Uf55yLHNR0Upu+UOTE8FI0nxrv4y7o2nopTcbQ5aJ4qdp9nfJVdCX0u7VpYGddQMDUvpsc1pYGddQMDno6CU3fKHLa8F9T7O+KNp6CU3G0OW14KRpPjXfCV0JfS7tWlgZxqPx7wNS+qx2rSwM4mQJ/wBwcDno6CU3fKHLRPBSNJG+DdbR0Epu+UOTxngCNJ9nKm66E7FVjmtHBddvO3o74hGp2KbHNa2BnXYT/wA2OCOajoJTd8octE8FI0nx5O+DdbR0Upu+UOWAngpGk+PJ3wbroS+mxzWlgZ11X8e8I1OxTY5rSwM66gT/AM94I5qeglN3yhy0TwUjSfHk74Xdep6KU3fKHLRPBSNJ8eTvg3XSnYpsc1pYGddQP4O+Ejydil3NaWBnXUef+HfBHNR0Upu+UOSBPBSNJ8eTvhd16nopTd8octE8FI0nx5O+DddKdimxzWlgZxqPP/DhIxOxTY7VpYC66j7ejvkWOenoJTb8octE8EIiJ8eTvlKyjopTd8ocsBPFI0kbnfIbrpTsU2Oa0sBddR/5g74Er2KbHNaWBnXVR9PWxwsc9PRSm42hywX9V9T7O+BlHRSm75g5aJ4rGk/XfLo6E7FNjmtHDOsyB/GQYnYpsc1rYC41Uf8AYwrnp6KU3G0OWieKkaT7O+N0ZT0UpuNoctrwUjSfZ3xR0J2KXc1pYGddQP494Hk7FLu1a2BnXUD+PeEc1PRSm75Q5aJ4r6nx5O+WpWU9FKbvlDlonisaT7O+KV0p2KbHatHBddV87eveIMTsUu5rSwM66gTt694SOanopTd8ocsBPBY0nx5O+KtZT0kpt+UOWAngvqRGu/jFV0L2KbHatbAXGo/HvIkSvYqdzWrgsNQP4xGo56eklNvyBy0TxX1PjXfLRNPTWm35QxIE8FO0+Nd8B1vqd2RbAXXUD+DhUrfU7lFcFl1UZUBT1Eqt+UMTH6KdpxFTV1EqtNgYnXivqfrvgp1uqdyiuCy6gYqMW6p3KK4LDUfjJVgKuotVvyBi2vFTtP1wVNXUWq02BiYnisaT48nItdC31O5RXBYaj8YRC31O5RXlhqP88ZTQVdVarPkDExPBfU/XfEN1NfVWuz5AxMfqp2nEKZbq2YorgsNvxlqMW6t2KK8sNh+clA19Va7PkDTE8V9T9cisq6y128wxMTxUj/WuEMt1bMUV5YbfjAhbkZiqtLbj8ZfgGvrrXZz5TEwIxnIyvrrW/PlMaDJmBFtrZiqtLDbNUjFtrZiiuCw2zKwVfWWuzmGmJhfvkKivrrXZzDk6wD9cuclKLq2YqrAsNRjBAtRmKhgWGoGazcQSddUfnyn0MznMWsr6y12fIGJ1gYzClW2tmKKwLDUYpEi6tmKhpI1GEga6FrsLhiY0H3+uIekpQEfmDP8AUepy5yu6QWIxKhpI1GXNxIwWIzFQ0sNRmaDShUfmDPoesmYtSlCo5efsPviKUWIWKBpYbDGakQLUZuIaWGuaagkpVHLgn6D1kzkYlCo5cGfQ9TkikFiMxVWlhqMehi21sxUMCw1GSlFX11rcuGn0PU5Iia+utdhfkT/UessTdMtqMxRWBYagZRK21sxVWlhqMiQVfWWuzmGJ1gepyLusr6y12cw0x+q+pyU3TLbWzFFaWGowkQttbMVVwWG2VoVfXWuzmGmJ4j1/vAivrrW/PlMTxHrECrbWzFFaWG2KVi21sxRXlhqMlQNfXWuzmGJieI++Qqa+utdhcNI8wPU5YpRbWzFVaWGwwRK2ozFVeWGoyqJOuqOX5ExMD1iCa+utdnMNOvEffJiEW2tmKqwLDYYKwW1sxVWlhqMiBr6612Fw0+h9/rgqa+utdnMNP9R6yxootRiVVgWGoyolbUZiqtLDUYqjroVH5hpj9R6nJBNdCo/PkTGgyM0otRmKhpYbDLVSLUZiqtJGoyIJKFR+YaY/UZRKUCt+cz6H/MZilFiM3BWBI1H2wJFiMSqtJGoy1RJQqPzBn0Pvkzn6MroWty4adYHqck+oQWIzFVYFhtlzRi2ozFVaSNRkqCroCOXDE6wMmYVKULW5fkT6H3xmKVbEZuKtJG2KiRahbirCRqMKNKFrfnJP9QcmYRKUKjlwxPoesRogsRmKq0sNRlGCxGYqrSRtioNKFRy4M+h98mYMShUfmDMaDESlWxGYqGlhqMtGCxGbirSRtipBV0BH58pj9RjOV9PJQEflymNBjOTeiCxGYqGkjbLUjwsRmKhpI2xSDSgI/LlMaDJnK708lAR+XKY0GM5N0gsRmKhpI2y1I8LEZioaSNsUg0oCPz5TGgyZyu9PJQEflymNBjOTeiCxGYqGkjbLUj//2Q%3D%3D') repeat-x #0C0D10;\n    }\n    \n    " + this.params.code_css + "\n    \n    .source_code {\n        font-size: 0.7em;\n        line-height: 1em;\n    }\n    \n    .slide pre.source_code {color: #252519;}\n    .slide pre.source_code a {color: #444;}\n    \n    </style>\n</head>\n<body>\n    <div id=\"impress\">\n        " + this.params.impress_html + "\n    </div>\n    <script>\n    </script>\n    <script>\n    /**\n     * impress.js\n     *\n     * impress.js is a presentation tool based on the power of CSS3 transforms and transitions\n     * in modern browsers and inspired by the idea behind prezi.com.\n     *\n     *\n     * Copyright 2011-2012 Bartek Szopka (@bartaz)\n     *\n     * Released under the MIT and GPL Licenses.\n     *\n     * ------------------------------------------------\n     *  author:  Bartek Szopka\n     *  version: 0.5.3\n     *  url:     http://bartaz.github.com/impress.js/\n     *  source:  http://github.com/bartaz/impress.js/\n     */\n    \n    /*jshint bitwise:true, curly:true, eqeqeq:true, forin:true, latedef:true, newcap:true,\n             noarg:true, noempty:true, undef:true, strict:true, browser:true */\n    \n    // You are one of those who like to know how thing work inside?\n    // Let me show you the cogs that make impress.js run...\n    (function ( document, window ) {\n        'use strict';\n        \n        // HELPER FUNCTIONS\n        \n        // `pfx` is a function that takes a standard CSS property name as a parameter\n        // and returns it's prefixed version valid for current browser it runs in.\n        // The code is heavily inspired by Modernizr http://www.modernizr.com/\n        var pfx = (function () {\n            \n            var style = document.createElement('dummy').style,\n                prefixes = 'Webkit Moz O ms Khtml'.split(' '),\n                memory = {};\n            \n            return function ( prop ) {\n                if ( typeof memory[ prop ] === \"undefined\" ) {\n                    \n                    var ucProp  = prop.charAt(0).toUpperCase() + prop.substr(1),\n                        props   = (prop + ' ' + prefixes.join(ucProp + ' ') + ucProp).split(' ');\n                    \n                    memory[ prop ] = null;\n                    for ( var i in props ) {\n                        if ( style[ props[i] ] !== undefined ) {\n                            memory[ prop ] = props[i];\n                            break;\n                        }\n                    }\n                \n                }\n                \n                return memory[ prop ];\n            };\n        \n        })();\n        \n        // `arraify` takes an array-like object and turns it into real Array\n        // to make all the Array.prototype goodness available.\n        var arrayify = function ( a ) {\n            return [].slice.call( a );\n        };\n        \n        // `css` function applies the styles given in `props` object to the element\n        // given as `el`. It runs all property names through `pfx` function to make\n        // sure proper prefixed version of the property is used.\n        var css = function ( el, props ) {\n            var key, pkey;\n            for ( key in props ) {\n                if ( props.hasOwnProperty(key) ) {\n                    pkey = pfx(key);\n                    if ( pkey !== null ) {\n                        el.style[pkey] = props[key];\n                    }\n                }\n            }\n            return el;\n        };\n        \n        // `toNumber` takes a value given as `numeric` parameter and tries to turn\n        // it into a number. If it is not possible it returns 0 (or other value\n        // given as `fallback`).\n        var toNumber = function (numeric, fallback) {\n            return isNaN(numeric) ? (fallback || 0) : Number(numeric);\n        };\n        \n        // `byId` returns element with given `id` - you probably have guessed that ;)\n        var byId = function ( id ) {\n            return document.getElementById(id);\n        };\n        \n        // `$` returns first element for given CSS `selector` in the `context` of\n        // the given element or whole document.\n        var $ = function ( selector, context ) {\n            context = context || document;\n            return context.querySelector(selector);\n        };\n        \n        // `$$` return an array of elements for given CSS `selector` in the `context` of\n        // the given element or whole document.\n        var $$ = function ( selector, context ) {\n            context = context || document;\n            return arrayify( context.querySelectorAll(selector) );\n        };\n        \n        // `triggerEvent` builds a custom DOM event with given `eventName` and `detail` data\n        // and triggers it on element given as `el`.\n        var triggerEvent = function (el, eventName, detail) {\n            var event = document.createEvent(\"CustomEvent\");\n            event.initCustomEvent(eventName, true, true, detail);\n            el.dispatchEvent(event);\n        };\n        \n        // `translate` builds a translate transform string for given data.\n        var translate = function ( t ) {\n            return \" translate3d(\" + t.x + \"px,\" + t.y + \"px,\" + t.z + \"px) \";\n        };\n        \n        // `rotate` builds a rotate transform string for given data.\n        // By default the rotations are in X Y Z order that can be reverted by passing `true`\n        // as second parameter.\n        var rotate = function ( r, revert ) {\n            var rX = \" rotateX(\" + r.x + \"deg) \",\n                rY = \" rotateY(\" + r.y + \"deg) \",\n                rZ = \" rotateZ(\" + r.z + \"deg) \";\n            \n            return revert ? rZ+rY+rX : rX+rY+rZ;\n        };\n        \n        // `scale` builds a scale transform string for given data.\n        var scale = function ( s ) {\n            return \" scale(\" + s + \") \";\n        };\n        \n        // `perspective` builds a perspective transform string for given data.\n        var perspective = function ( p ) {\n            return \" perspective(\" + p + \"px) \";\n        };\n        \n        // `getElementFromHash` returns an element located by id from hash part of\n        // window location.\n        var getElementFromHash = function () {\n            // get id from url # by removing `#` or `#/` from the beginning,\n            // so both \"fallback\" `#slide-id` and \"enhanced\" `#/slide-id` will work\n            return byId( window.location.hash.replace(/^#\\/?/,\"\") );\n        };\n        \n        // `computeWindowScale` counts the scale factor between window size and size\n        // defined for the presentation in the config.\n        var computeWindowScale = function ( config ) {\n            var hScale = window.innerHeight / config.height,\n                wScale = window.innerWidth / config.width,\n                scale = hScale > wScale ? wScale : hScale;\n            \n            if (config.maxScale && scale > config.maxScale) {\n                scale = config.maxScale;\n            }\n            \n            if (config.minScale && scale < config.minScale) {\n                scale = config.minScale;\n            }\n            \n            return scale;\n        };\n        \n        // CHECK SUPPORT\n        var body = document.body;\n        \n        var ua = navigator.userAgent.toLowerCase();\n        var impressSupported = \n                              // browser should support CSS 3D transtorms \n                               ( pfx(\"perspective\") !== null ) &&\n                               \n                              // and `classList` and `dataset` APIs\n                               ( body.classList ) &&\n                               ( body.dataset ) &&\n                               \n                              // but some mobile devices need to be blacklisted,\n                              // because their CSS 3D support or hardware is not\n                              // good enough to run impress.js properly, sorry...\n                               ( ua.search(/(iphone)|(ipod)|(android)/) === -1 );\n        \n        if (!impressSupported) {\n            // we can't be sure that `classList` is supported\n            body.className += \" impress-not-supported \";\n        } else {\n            body.classList.remove(\"impress-not-supported\");\n            body.classList.add(\"impress-supported\");\n        }\n        \n        // GLOBALS AND DEFAULTS\n        \n        // This is were the root elements of all impress.js instances will be kept.\n        // Yes, this means you can have more than one instance on a page, but I'm not\n        // sure if it makes any sense in practice ;)\n        var roots = {};\n        \n        // some default config values.\n        var defaults = {\n            width: 1024,\n            height: 768,\n            maxScale: 1,\n            minScale: 0,\n            \n            perspective: 1000,\n            \n            transitionDuration: 1000\n        };\n        \n        // it's just an empty function ... and a useless comment.\n        var empty = function () { return false; };\n        \n        // IMPRESS.JS API\n        \n        // And that's where interesting things will start to happen.\n        // It's the core `impress` function that returns the impress.js API\n        // for a presentation based on the element with given id ('impress'\n        // by default).\n        var impress = window.impress = function ( rootId ) {\n            \n            // If impress.js is not supported by the browser return a dummy API\n            // it may not be a perfect solution but we return early and avoid\n            // running code that may use features not implemented in the browser.\n            if (!impressSupported) {\n                return {\n                    init: empty,\n                    goto: empty,\n                    prev: empty,\n                    next: empty\n                };\n            }\n            \n            rootId = rootId || \"impress\";\n            \n            // if given root is already initialized just return the API\n            if (roots[\"impress-root-\" + rootId]) {\n                return roots[\"impress-root-\" + rootId];\n            }\n            \n            // data of all presentation steps\n            var stepsData = {};\n            \n            // element of currently active step\n            var activeStep = null;\n            \n            // current state (position, rotation and scale) of the presentation\n            var currentState = null;\n            \n            // array of step elements\n            var steps = null;\n            \n            // configuration options\n            var config = null;\n            \n            // scale factor of the browser window\n            var windowScale = null;        \n            \n            // root presentation elements\n            var root = byId( rootId );\n            var canvas = document.createElement(\"div\");\n            \n            var initialized = false;\n            \n            // STEP EVENTS\n            //\n            // There are currently two step events triggered by impress.js\n            // `impress:stepenter` is triggered when the step is shown on the \n            // screen (the transition from the previous one is finished) and\n            // `impress:stepleave` is triggered when the step is left (the\n            // transition to next step just starts).\n            \n            // reference to last entered step\n            var lastEntered = null;\n            \n            // `onStepEnter` is called whenever the step element is entered\n            // but the event is triggered only if the step is different than\n            // last entered step.\n            var onStepEnter = function (step) {\n                if (lastEntered !== step) {\n                    triggerEvent(step, \"impress:stepenter\");\n                    lastEntered = step;\n                }\n            };\n            \n            // `onStepLeave` is called whenever the step element is left\n            // but the event is triggered only if the step is the same as\n            // last entered step.\n            var onStepLeave = function (step) {\n                if (lastEntered === step) {\n                    triggerEvent(step, \"impress:stepleave\");\n                    lastEntered = null;\n                }\n            };\n            \n            // `initStep` initializes given step element by reading data from its\n            // data attributes and setting correct styles.\n            var initStep = function ( el, idx ) {\n                var data = el.dataset,\n                    step = {\n                        translate: {\n                            x: toNumber(data.x),\n                            y: toNumber(data.y),\n                            z: toNumber(data.z)\n                        },\n                        rotate: {\n                            x: toNumber(data.rotateX),\n                            y: toNumber(data.rotateY),\n                            z: toNumber(data.rotateZ || data.rotate)\n                        },\n                        scale: toNumber(data.scale, 1),\n                        el: el\n                    };\n                \n                if ( !el.id ) {\n                    el.id = \"step-\" + (idx + 1);\n                }\n                \n                stepsData[\"impress-\" + el.id] = step;\n                \n                css(el, {\n                    position: \"absolute\",\n                    transform: \"translate(-50%,-50%)\" +\n                               translate(step.translate) +\n                               rotate(step.rotate) +\n                               scale(step.scale),\n                    transformStyle: \"preserve-3d\"\n                });\n            };\n            \n            // `init` API function that initializes (and runs) the presentation.\n            var init = function () {\n                if (initialized) { return; }\n                \n                // First we set up the viewport for mobile devices.\n                // For some reason iPad goes nuts when it is not done properly.\n                var meta = $(\"meta[name='viewport']\") || document.createElement(\"meta\");\n                meta.content = \"width=device-width, minimum-scale=1, maximum-scale=1, user-scalable=no\";\n                if (meta.parentNode !== document.head) {\n                    meta.name = 'viewport';\n                    document.head.appendChild(meta);\n                }\n                \n                // initialize configuration object\n                var rootData = root.dataset;\n                config = {\n                    width: toNumber( rootData.width, defaults.width ),\n                    height: toNumber( rootData.height, defaults.height ),\n                    maxScale: toNumber( rootData.maxScale, defaults.maxScale ),\n                    minScale: toNumber( rootData.minScale, defaults.minScale ),                \n                    perspective: toNumber( rootData.perspective, defaults.perspective ),\n                    transitionDuration: toNumber( rootData.transitionDuration, defaults.transitionDuration )\n                };\n                \n                windowScale = computeWindowScale( config );\n                \n                // wrap steps with \"canvas\" element\n                arrayify( root.childNodes ).forEach(function ( el ) {\n                    canvas.appendChild( el );\n                });\n                root.appendChild(canvas);\n                \n                // set initial styles\n                document.documentElement.style.height = \"100%\";\n                \n                css(body, {\n                    height: \"100%\",\n                    overflow: \"hidden\"\n                });\n                \n                var rootStyles = {\n                    position: \"absolute\",\n                    transformOrigin: \"top left\",\n                    transition: \"all 0s ease-in-out\",\n                    transformStyle: \"preserve-3d\"\n                };\n                \n                css(root, rootStyles);\n                css(root, {\n                    top: \"50%\",\n                    left: \"50%\",\n                    transform: perspective( config.perspective/windowScale ) + scale( windowScale )\n                });\n                css(canvas, rootStyles);\n                \n                body.classList.remove(\"impress-disabled\");\n                body.classList.add(\"impress-enabled\");\n                \n                // get and init steps\n                steps = $$(\".step\", root);\n                steps.forEach( initStep );\n                \n                // set a default initial state of the canvas\n                currentState = {\n                    translate: { x: 0, y: 0, z: 0 },\n                    rotate:    { x: 0, y: 0, z: 0 },\n                    scale:     1\n                };\n                \n                initialized = true;\n                \n                triggerEvent(root, \"impress:init\", { api: roots[ \"impress-root-\" + rootId ] });\n            };\n            \n            // `getStep` is a helper function that returns a step element defined by parameter.\n            // If a number is given, step with index given by the number is returned, if a string\n            // is given step element with such id is returned, if DOM element is given it is returned\n            // if it is a correct step element.\n            var getStep = function ( step ) {\n                if (typeof step === \"number\") {\n                    step = step < 0 ? steps[ steps.length + step] : steps[ step ];\n                } else if (typeof step === \"string\") {\n                    step = byId(step);\n                }\n                return (step && step.id && stepsData[\"impress-\" + step.id]) ? step : null;\n            };\n            \n            // used to reset timeout for `impress:stepenter` event\n            var stepEnterTimeout = null;\n            \n            // `goto` API function that moves to step given with `el` parameter (by index, id or element),\n            // with a transition `duration` optionally given as second parameter.\n            var goto = function ( el, duration ) {\n                \n                if ( !initialized || !(el = getStep(el)) ) {\n                    // presentation not initialized or given element is not a step\n                    return false;\n                }\n                \n                // Sometimes it's possible to trigger focus on first link with some keyboard action.\n                // Browser in such a case tries to scroll the page to make this element visible\n                // (even that body overflow is set to hidden) and it breaks our careful positioning.\n                //\n                // So, as a lousy (and lazy) workaround we will make the page scroll back to the top\n                // whenever slide is selected\n                //\n                // If you are reading this and know any better way to handle it, I'll be glad to hear about it!\n                window.scrollTo(0, 0);\n                \n                var step = stepsData[\"impress-\" + el.id];\n                \n                if ( activeStep ) {\n                    activeStep.classList.remove(\"active\");\n                    body.classList.remove(\"impress-on-\" + activeStep.id);\n                }\n                el.classList.add(\"active\");\n                \n                body.classList.add(\"impress-on-\" + el.id);\n                \n                // compute target state of the canvas based on given step\n                var target = {\n                    rotate: {\n                        x: -step.rotate.x,\n                        y: -step.rotate.y,\n                        z: -step.rotate.z\n                    },\n                    translate: {\n                        x: -step.translate.x,\n                        y: -step.translate.y,\n                        z: -step.translate.z\n                    },\n                    scale: 1 / step.scale\n                };\n                \n                // Check if the transition is zooming in or not.\n                //\n                // This information is used to alter the transition style:\n                // when we are zooming in - we start with move and rotate transition\n                // and the scaling is delayed, but when we are zooming out we start\n                // with scaling down and move and rotation are delayed.\n                var zoomin = target.scale >= currentState.scale;\n                \n                duration = toNumber(duration, config.transitionDuration);\n                var delay = (duration / 2);\n                \n                // if the same step is re-selected, force computing window scaling,\n                // because it is likely to be caused by window resize\n                if (el === activeStep) {\n                    windowScale = computeWindowScale(config);\n                }\n                \n                var targetScale = target.scale * windowScale;\n                \n                // trigger leave of currently active element (if it's not the same step again)\n                if (activeStep && activeStep !== el) {\n                    onStepLeave(activeStep);\n                }\n                \n                // Now we alter transforms of `root` and `canvas` to trigger transitions.\n                //\n                // And here is why there are two elements: `root` and `canvas` - they are\n                // being animated separately:\n                // `root` is used for scaling and `canvas` for translate and rotations.\n                // Transitions on them are triggered with different delays (to make\n                // visually nice and 'natural' looking transitions), so we need to know\n                // that both of them are finished.\n                css(root, {\n                    // to keep the perspective look similar for different scales\n                    // we need to 'scale' the perspective, too\n                    transform: perspective( config.perspective / targetScale ) + scale( targetScale ),\n                    transitionDuration: duration + \"ms\",\n                    transitionDelay: (zoomin ? delay : 0) + \"ms\"\n                });\n                \n                css(canvas, {\n                    transform: rotate(target.rotate, true) + translate(target.translate),\n                    transitionDuration: duration + \"ms\",\n                    transitionDelay: (zoomin ? 0 : delay) + \"ms\"\n                });\n                \n                // Here is a tricky part...\n                //\n                // If there is no change in scale or no change in rotation and translation, it means there was actually\n                // no delay - because there was no transition on `root` or `canvas` elements.\n                // We want to trigger `impress:stepenter` event in the correct moment, so here we compare the current\n                // and target values to check if delay should be taken into account.\n                //\n                // I know that this `if` statement looks scary, but it's pretty simple when you know what is going on\n                // - it's simply comparing all the values.\n                if ( currentState.scale === target.scale ||\n                    (currentState.rotate.x === target.rotate.x && currentState.rotate.y === target.rotate.y &&\n                     currentState.rotate.z === target.rotate.z && currentState.translate.x === target.translate.x &&\n                     currentState.translate.y === target.translate.y && currentState.translate.z === target.translate.z) ) {\n                    delay = 0;\n                }\n                \n                // store current state\n                currentState = target;\n                activeStep = el;\n                \n                // And here is where we trigger `impress:stepenter` event.\n                // We simply set up a timeout to fire it taking transition duration (and possible delay) into account.\n                //\n                // I really wanted to make it in more elegant way. The `transitionend` event seemed to be the best way\n                // to do it, but the fact that I'm using transitions on two separate elements and that the `transitionend`\n                // event is only triggered when there was a transition (change in the values) caused some bugs and \n                // made the code really complicated, cause I had to handle all the conditions separately. And it still\n                // needed a `setTimeout` fallback for the situations when there is no transition at all.\n                // So I decided that I'd rather make the code simpler than use shiny new `transitionend`.\n                //\n                // If you want learn something interesting and see how it was done with `transitionend` go back to\n                // version 0.5.2 of impress.js: http://github.com/bartaz/impress.js/blob/0.5.2/js/impress.js\n                window.clearTimeout(stepEnterTimeout);\n                stepEnterTimeout = window.setTimeout(function() {\n                    onStepEnter(activeStep);\n                }, duration + delay);\n                \n                return el;\n            };\n            \n            // `prev` API function goes to previous step (in document order)\n            var prev = function () {\n                var prev = steps.indexOf( activeStep ) - 1;\n                prev = prev >= 0 ? steps[ prev ] : steps[ steps.length-1 ];\n                \n                return goto(prev);\n            };\n            \n            // `next` API function goes to next step (in document order)\n            var next = function () {\n                var next = steps.indexOf( activeStep ) + 1;\n                next = next < steps.length ? steps[ next ] : steps[ 0 ];\n                \n                return goto(next);\n            };\n            \n            // Adding some useful classes to step elements.\n            //\n            // All the steps that have not been shown yet are given `future` class.\n            // When the step is entered the `future` class is removed and the `present`\n            // class is given. When the step is left `present` class is replaced with\n            // `past` class.\n            //\n            // So every step element is always in one of three possible states:\n            // `future`, `present` and `past`.\n            //\n            // There classes can be used in CSS to style different types of steps.\n            // For example the `present` class can be used to trigger some custom\n            // animations when step is shown.\n            root.addEventListener(\"impress:init\", function(){\n                // STEP CLASSES\n                steps.forEach(function (step) {\n                    step.classList.add(\"future\");\n                });\n                \n                root.addEventListener(\"impress:stepenter\", function (event) {\n                    event.target.classList.remove(\"past\");\n                    event.target.classList.remove(\"future\");\n                    event.target.classList.add(\"present\");\n                }, false);\n                \n                root.addEventListener(\"impress:stepleave\", function (event) {\n                    event.target.classList.remove(\"present\");\n                    event.target.classList.add(\"past\");\n                }, false);\n                \n            }, false);\n            \n            // Adding hash change support.\n            root.addEventListener(\"impress:init\", function(){\n                \n                // last hash detected\n                var lastHash = \"\";\n                \n                // `#/step-id` is used instead of `#step-id` to prevent default browser\n                // scrolling to element in hash.\n                //\n                // And it has to be set after animation finishes, because in Chrome it\n                // makes transtion laggy.\n                // BUG: http://code.google.com/p/chromium/issues/detail?id=62820\n                root.addEventListener(\"impress:stepenter\", function (event) {\n                    window.location.hash = lastHash = \"#/\" + event.target.id;\n                }, false);\n                \n                window.addEventListener(\"hashchange\", function () {\n                    // When the step is entered hash in the location is updated\n                    // (just few lines above from here), so the hash change is \n                    // triggered and we would call `goto` again on the same element.\n                    //\n                    // To avoid this we store last entered hash and compare.\n                    if (window.location.hash !== lastHash) {\n                        goto( getElementFromHash() );\n                    }\n                }, false);\n                \n                // START \n                // by selecting step defined in url or first step of the presentation\n                goto(getElementFromHash() || steps[0], 0);\n            }, false);\n            \n            body.classList.add(\"impress-disabled\");\n            \n            // store and return API for given impress.js root element\n            return (roots[ \"impress-root-\" + rootId ] = {\n                init: init,\n                goto: goto,\n                next: next,\n                prev: prev\n            });\n    \n        };\n        \n        // flag that can be used in JS to check if browser have passed the support test\n        impress.supported = impressSupported;\n        \n    })(document, window);\n    \n    // NAVIGATION EVENTS\n    \n    // As you can see this part is separate from the impress.js core code.\n    // It's because these navigation actions only need what impress.js provides with\n    // its simple API.\n    //\n    // In future I think about moving it to make them optional, move to separate files\n    // and treat more like a 'plugins'.\n    (function ( document, window ) {\n        'use strict';\n        \n        // throttling function calls, by Remy Sharp\n        // http://remysharp.com/2010/07/21/throttling-function-calls/\n        var throttle = function (fn, delay) {\n            var timer = null;\n            return function () {\n                var context = this, args = arguments;\n                clearTimeout(timer);\n                timer = setTimeout(function () {\n                    fn.apply(context, args);\n                }, delay);\n            };\n        };\n        \n        // wait for impress.js to be initialized\n        document.addEventListener(\"impress:init\", function (event) {\n            // Getting API from event data.\n            // So you don't event need to know what is the id of the root element\n            // or anything. `impress:init` event data gives you everything you \n            // need to control the presentation that was just initialized.\n            var api = event.detail.api;\n            \n            // KEYBOARD NAVIGATION HANDLERS\n            \n            // Prevent default keydown action when one of supported key is pressed.\n            document.addEventListener(\"keydown\", function ( event ) {\n                if ( event.keyCode === 9 || ( event.keyCode >= 32 && event.keyCode <= 34 ) || (event.keyCode >= 37 && event.keyCode <= 40) ) {\n                    event.preventDefault();\n                }\n            }, false);\n            \n            // Trigger impress action (next or prev) on keyup.\n            \n            // Supported keys are:\n            // [space] - quite common in presentation software to move forward\n            // [up] [right] / [down] [left] - again common and natural addition,\n            // [pgdown] / [pgup] - often triggered by remote controllers,\n            // [tab] - this one is quite controversial, but the reason it ended up on\n            //   this list is quite an interesting story... Remember that strange part\n            //   in the impress.js code where window is scrolled to 0,0 on every presentation\n            //   step, because sometimes browser scrolls viewport because of the focused element?\n            //   Well, the [tab] key by default navigates around focusable elements, so clicking\n            //   it very often caused scrolling to focused element and breaking impress.js\n            //   positioning. I didn't want to just prevent this default action, so I used [tab]\n            //   as another way to moving to next step... And yes, I know that for the sake of\n            //   consistency I should add [shift+tab] as opposite action...\n            document.addEventListener(\"keyup\", function ( event ) {\n                if ( event.keyCode === 9 || ( event.keyCode >= 32 && event.keyCode <= 34 ) || (event.keyCode >= 37 && event.keyCode <= 40) ) {\n                    switch( event.keyCode ) {\n                        case 33: // pg up\n                        case 37: // left\n                        case 38: // up\n                                 api.prev();\n                                 break;\n                        case 9:  // tab\n                        case 32: // space\n                        case 34: // pg down\n                        case 39: // right\n                        case 40: // down\n                                 api.next();\n                                 break;\n                    }\n                    \n                    event.preventDefault();\n                }\n            }, false);\n            \n            // delegated handler for clicking on the links to presentation steps\n            document.addEventListener(\"click\", function ( event ) {\n                // event delegation with \"bubbling\"\n                // check if event target (or any of its parents is a link)\n                var target = event.target;\n                while ( (target.tagName !== \"A\") &&\n                        (target !== document.documentElement) ) {\n                    target = target.parentNode;\n                }\n                \n                if ( target.tagName === \"A\" ) {\n                    var href = target.getAttribute(\"href\");\n                    \n                    // if it's a link to presentation step, target this step\n                    if ( href && href[0] === '#' ) {\n                        target = document.getElementById( href.slice(1) );\n                    }\n                }\n                \n                if ( api.goto(target) ) {\n                    event.stopImmediatePropagation();\n                    event.preventDefault();\n                }\n            }, false);\n            \n            // delegated handler for clicking on step elements\n            document.addEventListener(\"click\", function ( event ) {\n                var target = event.target;\n                // find closest step element that is not active\n                while ( !(target.classList.contains(\"step\") && !target.classList.contains(\"active\")) &&\n                        (target !== document.documentElement) ) {\n                    target = target.parentNode;\n                }\n                \n                if ( api.goto(target) ) {\n                    event.preventDefault();\n                }\n            }, false);\n            \n            // touch handler to detect taps on the left and right side of the screen\n            // based on awesome work of @hakimel: https://github.com/hakimel/reveal.js\n            document.addEventListener(\"touchstart\", function ( event ) {\n                if (event.touches.length === 1) {\n                    var x = event.touches[0].clientX,\n                        width = window.innerWidth * 0.3,\n                        result = null;\n                        \n                    if ( x < width ) {\n                        result = api.prev();\n                    } else if ( x > window.innerWidth - width ) {\n                        result = api.next();\n                    }\n                    \n                    if (result) {\n                        event.preventDefault();\n                    }\n                }\n            }, false);\n            \n            // rescale presentation when window is resized\n            window.addEventListener(\"resize\", throttle(function () {\n                // force going to active step again, to trigger rescaling\n                api.goto( document.querySelector(\".active\"), 500 );\n            }, 250), false);\n            \n        }, false);\n            \n    })(document, window);\n    \n    // THAT'S ALL FOLKS!\n    //\n    // Thanks for reading it all.\n    // Or thanks for scrolling down and reading the last part.\n    //\n    // I've learnt a lot when building impress.js and I hope this code and comments\n    // will help somebody learn at least some part of it.\n    </script>\n    <script>impress().init();</script>\n</body>\n</html>");
              };
              return new Chocokup.Panel({
                where: where,
                impress_html: impress_html,
                css: returns.defaults.css,
                code_css: Highlight.defaultCodeCSS
              }, impress_kup).render();
            default:
              kup = function() {
                iterate = function(note, level) {
                  var ref7, ref8, ref9, results, results1, sub, title;
                  if ((title = note.title)[0] === '$') {
                    ref7 = note.subs;
                    for (uuid in ref7) {
                      if (!hasProp.call(ref7, uuid)) continue;
                      sub = ref7[uuid];
                      iterate(sub, level + 1);
                    }
                    return;
                  }
                  switch (level) {
                    case 0:
                      ref8 = note.subs;
                      results = [];
                      for (uuid in ref8) {
                        if (!hasProp.call(ref8, uuid)) continue;
                        sub = ref8[uuid];
                        results.push(iterate(sub, level + 1));
                      }
                      return results;
                      break;
                    case 1:
                      div({
                        "class": 'slide transitionSlide',
                        id: 'id_' + note.uuid
                      }, function() {
                        return section({
                          "class": 'middle'
                        }, function() {
                          h2(note.title_compacted);
                          img(function() {});
                          if (note.html_title_content != null) {
                            return text(note.html_title_content);
                          }
                        });
                      });
                      ref9 = note.subs;
                      results1 = [];
                      for (uuid in ref9) {
                        if (!hasProp.call(ref9, uuid)) continue;
                        sub = ref9[uuid];
                        results1.push(iterate(sub, level + 1));
                      }
                      return results1;
                      break;
                    case 2:
                      return div({
                        "class": 'slide',
                        id: 'id_' + note.uuid,
                        style: 'overflow-y:auto'
                      }, function() {
                        header({
                          html5: true
                        }, function() {
                          return h1(note.title_compacted);
                        });
                        return section(function() {
                          var size;
                          if (note.html_title_content != null) {
                            text(note.html_title_content);
                          }
                          if (note.subs.length > 0) {
                            size = Math.max(30 - 4 * (level + 1), 10);
                            return ul({
                              "class": 'bullets',
                              style: "font-size:" + size + "pt"
                            }, function() {
                              var ref10, results2;
                              ref10 = note.subs;
                              results2 = [];
                              for (uuid in ref10) {
                                if (!hasProp.call(ref10, uuid)) continue;
                                sub = ref10[uuid];
                                results2.push(iterate(sub, level + 1));
                              }
                              return results2;
                            });
                          }
                        });
                      });
                    default:
                      return li(function() {
                        var size;
                        text(note.html_title);
                        if (note.subs.length > 0) {
                          size = Math.max(30 - 4 * (level + 1), 10);
                          return ul({
                            style: "font-size:" + size + "pt"
                          }, function() {
                            var ref10, results2;
                            ref10 = note.subs;
                            results2 = [];
                            for (uuid in ref10) {
                              if (!hasProp.call(ref10, uuid)) continue;
                              sub = ref10[uuid];
                              results2.push(iterate(sub, level + 1));
                            }
                            return results2;
                          });
                        }
                      });
                  }
                };
                return iterate(this.params.note, 0);
              };
              slides_html = new Chocokup.Panel({
                note: result
              }, kup).render();
              slides_kup = function() {
                return text("  <html>\n  <head>\n    <meta charset=\"utf-8\" />\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=Edge;chrome=1\" />\n    <title>" + this.params.where + "</title>\n    <link href=\"https://fonts.googleapis.com/css?family=Droid+Sans|Droid+Sans+Mono\" rel=\"stylesheet\" type=\"text/css\" />\n    <link id=\"prettify-link\" href=\"/static/vendor/slides/css/prettify.css\" rel=\"stylesheet\" type=\"text/css\" />\n    <link href=\"/static/vendor/slides/css/moon.css\" class=\"theme\" rel=\"stylesheet\" type=\"text/css\" />\n    <link href=\"/static/vendor/slides/css/sand.css\" class=\"theme\" rel=\"stylesheet\" type=\"text/css\" />\n    <link href=\"/static/vendor/slides/css/sea_wave.css\" class=\"theme\" rel=\"stylesheet\" type=\"text/css\" />\n    <link href=\"/static/vendor/slides/css/default.css\" class=\"theme\" rel=\"stylesheet\" type=\"text/css\" media=\"screen\"  />\n    <link href=\"/static/vendor/slides/css/common.css\" rel=\"stylesheet\" type=\"text/css\" media=\"screen\" />\n    <style>\n      .slide li, .slide p {\n        font-size: 28px;\n        line-height: 1em;\n      }\n      .slide li {\n        list-style-type: disc;\n      }\n      .slide pre {\n        margin: 0.5em 0;\n        font-family: 'Droid Sans Mono';\n        font-size: 20px;\n      }\n\n      .slide code {\n        font-family: 'Droid Sans Mono';\n        font-size: 90%;\n      }\n    </style>\n  </head>\n  <body>\n    <nav id=\"helpers\">\n      <button title=\"Previous slide\" id=\"nav-prev\" class=\"nav-prev\">←</button> \n      <button title=\"Jump to a random slide\" id=\"slide-no\">5</button> \n      <button title=\"Next slide\" id=\"nav-next\" class=\"nav-next\">→</button>\n      <menu>\n        <button type=\"checkbox\" data-command=\"toc\" title=\"Table of Contents\" class=\"toc\">TOC</button>\n        <!-- <button type=\"checkbox\" data-command=\"resources\" title=\"View Related Resources\">?</button> -->\n        <button type=\"checkbox\" data-command=\"notes\" title=\"View Slide Notes\">✏</button>\n        <button type=\"checkbox\" data-command=\"source\" title=\"View slide source\">↻</button>\n        <button type=\"checkbox\" data-command=\"help\" title=\"View Help\">?</button>\n      </menu>\n    </nav>\n    <div class=\"presentation\">\n      <div id=\"presentation-counter\">Loading...</div>\n      <div class=\"slides\">\n        <div class=\"slide\" id=\"landing-slide\">\n          <style>\n            #landing-slide p {\n              font-size: 35px;\n            }\n            p#disclaimer-message {\n              font-size: 20px;\n            }\n          </style>\n          <section class=\"middle\">\n            <p>This presentation is an HTML5 website</p>\n            <p>Press <span id=\"left-init-key\" class=\"key\">&rarr;</span> key to advance.</p>\n            <p id=\"disclaimer-message\">Having issues seeing the presentation? Read the <a href=\"https://cdn.rawgit.com/html5rocks/slides.html5rocks.com/master/disclaimer.html\">disclaimer</a></p>\n          </section>\n          <aside class=\"note\">\n            <section>\n              Welcome! (This field is for presenter notes and commentary.)\n            </section>\n          </aside> \n        </div>\n        <div class=\"slide\" id=\"controls-slide\">\n          <header>Slides controls</header>\n          <style>\n            #controls-slide li, #controls-slide p {\n              font-size: 32px;\n            }\n            #controls-slide .key {\n              bottom: 2px;\n            }\n          </style>\n          <section>\n            <ul>\n              <li><span class=\"key\">&larr;</span> and <span class=\"key\">&rarr;</span> to move around.</li>\n              <li><span class=\"key\">Ctrl/Command</span> and <span class=\"key\">+</span> or <span class=\"key\">-</span> to zoom in and out if slides don’t fit.</li>\n              <li><span class=\"key\">S</span> to view page source.</li>\n              <li><span class=\"key\">T</span> to change the theme.</li>\n              <li><span class=\"key\">H</span> to toggle syntax highlight.</li>\n              <li><span class=\"key\">N</span> to toggle speaker notes.</li>\n              <li><span class=\"key\">3</span> to toggle 3D effect.</li>\n              <li><span class=\"key\">0</span> to toggle help.</li>\n            </ul>\n          </section>\n        </div>\n        <div class=\"slide\" id=\"table-of-contents\">\n          <header><h1>Today, we will cover...</h1></header>\n          <style>\n            #toc-list > li {\n              font-size: 26px;\n              line-height: 33px;\n              opacity: 0.85;\n            }\n            #toc-list > li:hover {\n              opacity: 1;\n            }\n            #toc-list a {\n              border-bottom: 0;\n            }\n            #toc-list a:hover{\n              border-bottom: 2px solid #3f3f3f;\n            }\n            #toc-list img {\n              vertical-align: middle;\n              margin-left: 15px;\n            }\n          </style>\n          <section>\n            <ul id=\"toc-list\">\n            </ul>\n          </section>\n        </div>\n        " + this.params.slides_html + "\n\n      </div> <!-- slides -->\n      <div id=\"speaker-note\" class=\"invisible\" style=\"display: none;\">\n      </div> <!-- speaker note -->\n      <aside id=\"help\" class=\"sidebar invisible\" style=\"display: hidden;\">\n        <table>\n          <caption>Help</caption>\n          <tbody>\n            <tr>\n              <th>Move Around</th>\n              <td>&larr;&nbsp;&rarr;</td>\n            </tr>\n            <tr>\n              <th>Source File</th>\n              <td>s</td>\n            </tr>\n            <tr>\n              <th>Change Theme</th>\n              <td>t</td>\n            </tr>\n            <tr>\n              <th>Syntax Highlight</th>\n              <td>h</td>\n            </tr>\n            <tr>\n              <th>Speaker Notes</th>\n              <td>n</td>\n            </tr>\n            <tr>\n              <th>Toggle 3D</th>\n              <td>3</td>\n            </tr>\n            <tr>\n              <th>Help</th>\n              <td>0</td>\n            </tr>\n          </tbody>\n        </table>\n      </aside>\n    </div> <!-- presentation -->\n\n    <!--[if lt IE 9]>\n    <script \n      src=\"http://ajax.googleapis.com/ajax/libs/chrome-frame/1/CFInstall.min.js\">\n    </script>\n    <script>CFInstall.check({ mode: \"overlay\" });</script>\n    <![endif]-->\n\n    <script src=\"/static/vendor/slides/prettify.js\" onload=\"prettyPrint();\" defer></script>\n    <script src=\"/static/vendor/slides/utils.js\"></script>\n  </body>\n</html>");
              };
              return new Chocokup.Panel({
                where: where,
                slides_html: slides_html
              }, slides_kup).render();
          }
        }
      }
    };

    return _Class;

  })();

  _module = typeof window !== "undefined" && window !== null ? window : module;

  _module[_module.exports != null ? "exports" : "Newnotes"] = Newnotes;

}).call(this);
